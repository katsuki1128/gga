<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ã‚¹ã‚¿ãƒ³ãƒ—ã‚¯ãƒªã‚¢ç”»é¢</title>

  <!-- CSS & Tailwind -->
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/reset.css" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/flowbite@1.4.4/dist/flowbite.min.css" />

  <!-- jQuery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

  <!-- fontAwesome -->
  <script src="https://kit.fontawesome.com/e6a146d4cb.js" crossorigin="anonymous"></script>
</head>

<body>

  <!----------------------------------------------
    â­ï¸ã“ã“ãŒå¤§å…ƒï¼ã‚¹ã‚¿ãƒ³ãƒ—ç”Ÿæˆãƒ–ãƒ­ãƒƒã‚¯  
    ------------------------------------------------->
  <!-- â­ï¸ã‚¹ã‚¿ãƒ³ãƒ—è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
  <section class="bg-gray-200">
    <div class="flex flex-col items-center justify-center px-6 pt-8 pb-4 mx-auto">
      <div class="w-full bg-white rounded-lg shadow sm:max-w-3xl md:w-4/5 xl:p-0">
        <div class="p-6 space-y-4 md:space-y-6 sm:p-8">
          <div>
            <a href="index.html">
              <img class="w-full h-15 mr-2" src="img/startup_kyushu.png" alt="logo" />
            </a>
          </div>
        </div>
        <div class="flex flex-col items-center justify-center ">


          <h1 class="text-xl font-bold  text-purple-800">
            ã‚¹ã‚¿ãƒ³ãƒ—ã‚¯ãƒªãƒƒã‚¯æ•°
          </h1>

          <!-- â­ï¸å††ã‚°ãƒ©ãƒ•è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
          <div class="flex flex-col items-center justify-center" id="chart_wrapper">
            <canvas id="myChart" style="width: 300px; height: 300px"></canvas>
          </div>
          <div class="m-2">
            <a class="btn-emergency-real">

              <span class="btn-emergency-real-bottom"></span>
              <span class="btn-emergency-real-top" id="resetButton"><span>ã‚¯ãƒªã‚¢</span></span>
            </a>
          </div>

        </div>
      </div>
    </div>
  </section>

  <script type="module">
    //----------------------------------------
    // â–¼firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨javaScriptã‚’é€£æºã•ã›ã‚‹
    //----------------------------------------

    // å¿…è¦ãªæ©Ÿèƒ½ã‚’SDKã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";

    // firebase firestoreã¨ã‚„ã‚Šå–ã‚Šã‚’ã™ã‚‹è¨­å®š
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      query,
      orderBy, //ãƒ‡ãƒ¼ã‚¿ã®ã‚½ãƒ¼ãƒˆ
      onSnapshot, // Firestore ä¸Šã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      doc,
      deleteDoc,
      updateDoc,
      getDocs,
      getDoc,
      increment
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // firebase storageã¨ã‚„ã‚Šå–ã‚Šã‚’ã™ã‚‹è¨­å®š
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL,
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

    // ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®Firebaseã®è¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyBs-rcINsUSZe7bD7OeLTrNcXm6-OInABg",
      authDomain: "tvcha-9cae7.firebaseapp.com",
      projectId: "tvcha-9cae7",
      storageBucket: "tvcha-9cae7.appspot.com",
      messagingSenderId: "866848033597",
      appId: "1:866848033597:web:c6887382eb14ee58351354",
    };

    // Firebaseã®åˆæœŸåŒ–
    const app = initializeApp(firebaseConfig);

    // Firebaseã‚¢ãƒ—ãƒªã¨Cloud Storageã®é€£æºã‚’åˆæœŸåŒ–ã—ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹
    const storage = getStorage(app);

    // dbã«å¯¾ã—ã¦ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ ã‚„å–å¾—ãŒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
    const db = getFirestore(app);

    // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®åå‰ã‚’å®šç¾©
    const collectionName = "gga";

    // ğŸ”½ ãƒ‡ãƒ¼ã‚¿å–å¾—æ¡ä»¶ã®æŒ‡å®šï¼ˆä»Šå›ã¯orderé †ã«ä¸¦ã³æ›¿ãˆã¦å–å¾—ï¼‰
    const q = query(collection(db, collectionName), orderBy("order", "desc"));

    //----------------------------------------
    // â–¼ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¼ãƒ­ã«ã™ã‚‹é–¢æ•°
    //----------------------------------------
    async function resetCount() {

      const querySnapshot = await getDocs(q)

      querySnapshot.forEach(async (doc) => {
        try {
          // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          const docData = doc.data();

          // ã‚«ã‚¦ãƒ³ãƒˆã‚’0ã«è¨­å®š
          docData.count = 0;

          // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
          await updateDoc(doc.ref, docData);
        } catch (error) {
          console.error("ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
        }
      });

      // alert("ã‚«ã‚¦ãƒ³ãƒˆã‚’0ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
    }

    // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
    const resetButton = document.getElementById("resetButton");
    resetButton.addEventListener("click", resetCount);

    //----------------------------------------
    // â–¼å¤‰æ›´ãƒœã‚¿ãƒ³é–¢æ•°
    //----------------------------------------

    // ãƒ‡ãƒ¼ã‚¿å–å¾—å‡¦ç†(ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸Šã§ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ãŒç™ºç”Ÿã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ {} å†…ã®å‡¦ç†ã‚’å®Ÿè¡Œ)
    onSnapshot(q, (querySnapshot) => {
      const array = [];
      querySnapshot.docs.forEach(function (doc) {
        const document = {
          id: doc.id,
          data: doc.data(),
        };
        array.push(document);
      });

      const pointData = []; // pointDataã‚’åˆæœŸåŒ–ã—ã¦ãŠã
      const countData = []; // countDataã‚’åˆæœŸåŒ–ã—ã¦ãŠã
      const imageUrls = []; // imageUrlsã‚’åˆæœŸåŒ–ã—ã¦ãŠã

      console.log(array);
      //----------------------------------------
      // id: 'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ID',
      // data: {
      //      img: 'ç”»åƒã®URL',
      //      point: 'ãƒã‚¤ãƒ³ãƒˆ',
      //      count: 'ã‚«ã‚¦ãƒ³ãƒˆ',
      //      time: 'ä½œæˆæ—¥æ™‚ãªã©'
      // countData : 'ã‚«ã‚¦ãƒ³ãƒˆã®é…åˆ—',
      // imageUrls : 'ç”»åƒã®URLã®é…åˆ—'
      //----------------------------------------

      array.forEach(function (document, index) {
        countData.push(document.data.count);
      });


      //----------------------------------------
      // â–¼ãƒãƒ£ãƒ¼ãƒˆã®æç”»
      //----------------------------------------

      // è‰²ã®è¨­å®š
      const colors = [
        "#7e7d9d",
        "#9d97b1",
        "#e1e1f0",
        "#bfb8c6",
        "#9e8f9e",
        "#1e1e33",
      ].slice(0, array.length);

      // ãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹å‰ã«æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
      const existingChart = Chart.getChart("myChart");
      if (existingChart) {
        existingChart.destroy();
      }

      // ãƒãƒ£ãƒ¼ãƒˆã®æç”»
      const canvas = document.getElementById("myChart");
      canvas.width = 200;
      canvas.height = 200;
      const ctx = canvas.getContext("2d");

      function drawImageLabel(context) { }

      const myChart = new Chart(ctx, {
        type: "doughnut",
        data: {
          datasets: [
            {
              data: countData,
              backgroundColor: colors,
            },
          ],
        },
        plugins: [ChartDataLabels],

        options: {
          plugins: {
            datalabels: {
              color: "#000",
              font: {
                size: 18,
              },

              display: true,
            },
            legend: {},
          },
        },
      });
    });
  </script>
</body>

</html>