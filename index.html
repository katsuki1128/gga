<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport"
    content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">


  <title>GGA2023Autumn</title>

  <!-- CSS & Tailwind -->
  <!-- <link rel="stylesheet" href="css/reset.css" /> -->
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://cdn.tailwindcss.com"></script>

</head>

<body>
  <!----------------------------------------------
    â­ï¸ã‚¿ã‚¤ãƒˆãƒ«
    ------------------------------------------------->
  <section>
    <div class="flex flex-col items-center justify-center">
      <div class="canvas-wrapper relative">
        <img src="img/tv2.png">
        <canvas id="overlay"></canvas>
      </div>
    </div>
  </section>
  <div>
    <!-- <div class="canvas-wrapper relative z-10" style="position: relative; bottom: 50px;"> -->
    <!-- <button id="resetButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full">
        clear
      </button> -->
    <!-- </div> -->
  </div>
  <!-- å·¦ä¸‹ã®A_Groupã®ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸è¡¨ç¤º -->
  <div id="AGroupPercentage" style="font-size: 100px; position: absolute; bottom: 21px; left: 71px;">
  </div>

  <!-- å·¦ä¸‹ã®A_Groupã®å€‹æ•°è¡¨ç¤º -->
  <div id="AGroupCount" class="stampCount" style="font-size: 20px; position: absolute; bottom: 0; left: 0;z-index: 5">
  </div>

  <!-- å³å´ã®B_Groupã®ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸è¡¨ç¤º -->
  <div id="BGroupPercentage" style="font-size: 100px; position: absolute; bottom: 21px; right: -55px;"></div>

  <!-- å³ä¸‹ã®A_Groupã®å€‹æ•°è¡¨ç¤º -->
  <div id="BGroupCount" class="stampCount" style="font-size: 20px; position: absolute; bottom: 0; right: 0;z-index: 5">
  </div>

  <!----------------------------------------------
    â­ï¸æ³¨æ„æ›¸ã
    ------------------------------------------------->
  <div class="flex flex-col items-center justify-center px-2 py-2 mx-auto bg-gray-200 rounded-lg shadow-lg">
    <div class="w-full bg-white rounded-lg shadow-md sm:max-w-3xl md:w-4/5 xl:p-0">
      <div class="px-2 py-2 space-y-2 md:space-y-2 sm:p-2">
        <div>
          <div class="text-left mb-2">
            <p class="text-lg font-bold">
              â­ï¸ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ãƒ†ãƒ¬ãƒ“ã«é£›ã°ã›ã¾ã™
            </p>
            <p class="text-lg font-bold">
              â­ï¸éŸ³å£°ãŒå‡ºã¾ã™â™ª
            </p>
            <p class="text-lg font-bold">
              â­ï¸ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
              <button id="resetButton"
                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 text-sm rounded-full">
                clear
              </button>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!----------------------------------------------
    â­ï¸ã‚¹ã‚¿ãƒ³ãƒ—è¡¨ç¤ºã‚¨ãƒªã‚¢
    ------------------------------------------------->
  </div>
  <div id="stampListContainer" class="flex flex-wrap justify-between p-1">
  </div>

  <!----------------------------------------------
    â­ï¸å®Ÿéš›ã®UIã¸ã®ãƒªãƒ³ã‚¯
    ------------------------------------------------->
  </div>
  <a href="tvcha.html">å®Ÿéš›ã®UI</a>
  </div>

  <script type="module">
    //------------------------------------------
    // â–¼firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨javaScriptã‚’é€£æºã•ã›ã‚‹
    //------------------------------------------


    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";

    // firebase firestoreã¨ã‚„ã‚Šå–ã‚Šã‚’ã™ã‚‹è¨­å®š
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      query,
      orderBy, //ãƒ‡ãƒ¼ã‚¿ã®ã‚½ãƒ¼ãƒˆ
      onSnapshot, // Firestore ä¸Šã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      doc,
      deleteDoc,
      updateDoc,
      getDocs,
      getDoc,
      increment,
    } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";

    // firebase storageã¨ã‚„ã‚Šå–ã‚Šã‚’ã™ã‚‹è¨­å®š
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL,
    } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-storage.js";

    // ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®Firebaseã®è¨­å®š
    const firebaseConfig = {
      apiKey: "",
      authDomain: "tvcha-9cae7.firebaseapp.com",
      projectId: "tvcha-9cae7",
      storageBucket: "tvcha-9cae7.appspot.com",
      messagingSenderId: "866848033597",
      appId: "1:866848033597:web:c6887382eb14ee58351354",
    };

    // Firebaseã®åˆæœŸåŒ–
    const app = initializeApp(firebaseConfig);

    // Firebaseã‚¢ãƒ—ãƒªã¨Cloud Storageã®é€£æºã‚’åˆæœŸåŒ–ã—ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹
    const storage = getStorage(app);

    // dbã«å¯¾ã—ã¦ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ ã‚„å–å¾—ãŒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
    const db = getFirestore(app);

    // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®åå‰ã‚’å®šç¾©
    const collectionName = "gga";
    // const collectionUsernName = "alter-user";

    // ğŸ”½ ãƒ‡ãƒ¼ã‚¿å–å¾—æ¡ä»¶ã®æŒ‡å®šï¼ˆä»Šå›ã¯orderé †ã«ä¸¦ã³æ›¿ãˆã¦å–å¾—ï¼‰
    const q = query(collection(db, collectionName), orderBy("order", "desc"));

    //----------------------------------------
    // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¹ã‚¿ãƒ³ãƒ—ã®URLã‚’æ ¼ç´ã™ã‚‹é…åˆ—
    //----------------------------------------
    let clickStamp = "";
    const clickStamps = [];
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    const stamps = []; // ã‚¹ã‚¿ãƒ³ãƒ—ã®æƒ…å ±ã‚’ä¿æŒã™ã‚‹é…åˆ—

    //----------------------------------------
    // â–¼ã‚¹ã‚¿ãƒ³ãƒ—ã®ã‚¯ãƒªãƒƒã‚¯æ•°ã‚«ã‚¦ãƒ³ãƒˆ
    //----------------------------------------
    let AGroupCount = 0;
    let BGroupCount = 0;
    let totalCount = 0;
    let AGroupPercentage = 0;
    let BGroupPercentage = 0;

    // Aã‚°ãƒ«ãƒ¼ãƒ—ã¨Bã‚°ãƒ«ãƒ¼ãƒ—ã®IDã®ãƒªã‚¹ãƒˆ
    const AGroupIds = ['xrnvFgD3PCjestA64SGd', 'Sw077n0mreVj9exRh81f', 'hgGsPbYmVKtw1ZLxljcr', 'ZXxNNOE8iKsrg8x3UiZ8'];
    const BGroupIds = ['NgLy7OAjlR6b7LF3Bfmp', 'p1DmVCDLRcPBgpdGfTuY', 'gfYdaXfqBcumPyn5puV9', 'p5s07tA6fzySQYgkNyxf'];

    //----------------------------------------
    // ã‚«ã‚¦ãƒ³ãƒˆã¨ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°

    //----------------------------------------
    const calculateCountsAndPercentages = (docs) => {
      // ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
      AGroupCount = 0;
      BGroupCount = 0;
      totalCount = 0;

      // å„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚«ã‚¦ãƒ³ãƒˆã‚’é›†è¨ˆã™ã‚‹
      docs.forEach((doc) => {
        const docId = doc.id;
        const docCount = doc.data().count || 0;

        if (AGroupIds.includes(docId)) {
          AGroupCount += docCount;
        }
        if (BGroupIds.includes(docId)) {
          BGroupCount += docCount;
        }
      });

      // åˆè¨ˆã‚«ã‚¦ãƒ³ãƒˆã¨ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã‚’è¨ˆç®—
      totalCount = AGroupCount + BGroupCount;
      AGroupPercentage = (totalCount > 0) ? (AGroupCount / totalCount) * 100 : 0;
      BGroupPercentage = (totalCount > 0) ? (BGroupCount / totalCount) * 100 : 0;

      // çµæœã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
      console.log('AGroupCount:', AGroupCount, 'BGroupCount:', BGroupCount);
      console.log('AGroupPercentage:', AGroupPercentage.toFixed(2), 'BGroupPercentage:', BGroupPercentage.toFixed(2));
    };

    //----------------------------------------
    // â–¼æœ€åˆã®ã‚¹ã‚¿ãƒ³ãƒ—ç”»åƒãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    //----------------------------------------

    const initialSnapshot = await getDocs(q);
    // calculateCountsAndPercentages(initialSnapshot.docs);

    const initialArray = initialSnapshot.docs.map(doc => ({
      id: doc.id,
      data: doc.data(),
    }));

    const initialImageUrls = initialArray.map(doc => doc.data.img);



    // ãƒ‡ãƒ¼ã‚¿å–å¾—å‡¦ç†(ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸Šã§ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ãŒç™ºç”Ÿã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ {} å†…ã®å‡¦ç†ã‚’å®Ÿè¡Œ)
    onSnapshot(q, (querySnapshot) => {
      calculateCountsAndPercentages(querySnapshot.docs);
      drawBarGraph(AGroupPercentage, BGroupPercentage);

      querySnapshot.docChanges().forEach((change) => {
        if (change.type === "modified") {
          const stampURL = change.doc.data().img;
          drawImageOnCanvas(stampURL);
          // console.log(stampURL);
        }
      });
    });

    //----------------------------------------
    // â–¼ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    //----------------------------------------

    const imageElements = [];

    const renderImages = () => {
      stampListContainer.innerHTML = '';

      initialImageUrls.forEach((imageUrl, index) => {
        const imageWrapper = document.createElement('div');
        imageWrapper.className = 'image-wrapper';

        const imageElement = document.createElement('img');
        imageElement.src = imageUrl;
        imageElement.className = 'image';
        imageElement.style.marginBottom = '8px';
        imageElements.push(imageElement)

        imageWrapper.appendChild(imageElement);

        stampListContainer.appendChild(imageWrapper);
      });
    }
    renderImages();

    // console.log("imageElements", imageElements);

    //----------------------------------------
    // â–¼ã‚¹ã‚¿ãƒ³ãƒ—ã‚¯ãƒªãƒƒã‚¯é–¢æ•°
    //----------------------------------------
    const stampClick = async (stampId) => {

      // Firebaseã®ã‚¯ãƒªãƒƒã‚¯æ•°ã‚’ä¸€ã¤å¢—ã‚„ã™
      await updateDoc(doc(db, collectionName, stampId), {
        count: increment(1)
      });
      // console.log("ã‚«ã‚¦ãƒ³ãƒˆãŒæ­£å¸¸ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸã‚ˆã€‚");
    };
    //----------------------------------------
    // â–¼ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¹ã‚¿ãƒ³ãƒ—ã®IDã‚’å–å¾—ã™ã‚‹é–¢æ•°
    //----------------------------------------
    let isSoundOn = true; // éŸ³å£°ã®ã‚ªãƒ³/ã‚ªãƒ•ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ãŸã‚ã®å¤‰æ•°
    let isClickDisabled = false; // ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹ãƒ•ãƒ©ã‚°

    // ç”»åƒè¦ç´ ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    imageElements.forEach((imageElement, index) => {
      imageElement.addEventListener('click', () => {

        // console.log(imageElement.src);

        // ã‚¯ãƒªãƒƒã‚¯ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
        // if (isClickDisabled) return;

        const stampId = initialArray[index].id; // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®IDã‚’å–å¾—
        setTimeout(() => {
          stampClick(stampId);
        }, 1000);

        // ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®æŒ™å‹•
        imageElement.classList.add('clicked-image'); // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‰ 'clicked-image' ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
        // isClickDisabled = true; // ã‚¯ãƒªãƒƒã‚¯ã‚’ç„¡åŠ¹åŒ–

        setTimeout(() => {
          imageElement.classList.remove('clicked-image'); // ä¸€å®šæ™‚é–“çµŒéå¾Œã« 'clicked-image' ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
          // isClickDisabled = false; // ä¸€å®šæ™‚é–“å¾Œã«ã‚¯ãƒªãƒƒã‚¯ã‚’å†åº¦æœ‰åŠ¹ã«ã™ã‚‹
        }, 1000);


        //----------------------------------------
        // â–¼ã‚µã‚¦ãƒ³ãƒ‰ã®å†ç”Ÿ
        //----------------------------------------
        if (isSoundOn) {  // isSoundOnãŒtrueã®å ´åˆã®ã¿éŸ³å£°ã‚’å†ç”Ÿ
          playSound(stampId);
          // console.log(id)
        };
      });
    });

    //----------------------------------------
    // â–¼éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ç”Ÿã™ã‚‹é–¢æ•°
    //----------------------------------------
    const playSound = (id) => {
      // const AGroupIds = ['Sw077n0mreVj9exRh81f', 'xrnvFgD3PCjestA64SGd', 'ZXxNNOE8iKsrg8x3UiZ8', 'hgGsPbYmVKtw1ZLxljcr'];
      // const BGroupIds = ['p1DmVCDLRcPBgpdGfTuY', 'NgLy7OAjlR6b7LF3Bfmp', 'xrnvFgD3PCjestA64SGd', 'gfYdaXfqBcumPyn5puV9'];
      const audioSet = {
        [AGroupIds[0]]: './sound/a1.mp3',
        [AGroupIds[1]]: './sound/a2.mp3',
        [AGroupIds[2]]: './sound/a3.mp3',
        [AGroupIds[3]]: './sound/a4.mp3',
        [BGroupIds[0]]: './sound/b1.mp3',
        [BGroupIds[1]]: './sound/b2.mp3',
        [BGroupIds[2]]: './sound/b3.mp3',
        [BGroupIds[3]]: './sound/b4.mp3',
      };

      const audioPath = audioSet[id] || './img/default.mp3'; // idãŒå­˜åœ¨ã—ãªã„å ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéŸ³å£°
      const audio = new Audio(audioPath);
      // console.log(audio)
      audio.play();
    };

    //----------------------------------------
    // â–¼canvasèƒŒæ™¯ã®ç”»åƒã®å¤§ãã•ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    //----------------------------------------

    let canvasImage = document.querySelector('.canvas-wrapper img');

    // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒãƒªã‚µã‚¤ã‚ºã•ã‚ŒãŸã¨ãã‚‚ã€ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’å†è¨­å®šã™ã‚‹
    window.addEventListener('resize', function () {
      canvas.width = canvasImage.width;
      canvas.height = canvasImage.height;
    });

    // ç”»åƒãŒã™ã§ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆã®å¯¾å‡¦
    if (canvasImage.complete) {
      canvas.width = canvasImage.width;
      canvas.height = canvasImage.height;
    }
    //----------------------------------------
    // ãƒ†ãƒ¬ãƒ“ã®ä¸­ã®åº§æ¨™
    //----------------------------------------

    // çŸ©å½¢ã®å·¦ä¸Šéš…ã®åº§æ¨™
    const rectX = canvas.width / 10.2;
    const rectY = canvas.height / 14.5;

    // çŸ©å½¢ã®å¹…ã¨é«˜ã•
    const rectWidth = canvas.width / 1.265;
    const rectHeight = canvas.height / 1.65;

    // çŸ©å½¢ã®æç”»
    // ctx.fillStyle = 'rgba(128, 0, 128, 0.5)'; // 50%ã®é€æ˜åº¦ã§ç´«è‰²
    // ctx.fillRect(rectX, rectY, rectWidth, rectHeight);

    // å·¦ä¸‹ã®åº§æ¨™
    const bottomLeftX = rectX;
    const bottomLeftY = rectY + rectHeight;

    // å³ä¸‹ã®åº§æ¨™
    const bottomRightX = rectX + rectWidth;
    const bottomRightY = rectY + rectHeight;

    // å¤‰æ•°ã«æ ¼ç´
    let bottomLeft = { x: bottomLeftX, y: bottomLeftY };
    let bottomRight = { x: bottomRightX, y: bottomRightY };


    //----------------------------------------
    // â–¼ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã®ã‚¤ãƒ¼ã‚ºã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    //----------------------------------------

    let previousAGroupPercentage = 0; // å‰å›ã®ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
    let previousBGroupPercentage = 0; // å‰å›ã®BGroupPercentageã‚’ä¿æŒã™ã‚‹å¤‰æ•°ã‚’è¿½åŠ 

    function easeInAnimation(startValue, endValue, duration, updateFunction) {
      let startTime = null;

      function animate(time) {
        if (!startTime) startTime = time;

        let elapsedTime = time - startTime;
        let progress = elapsedTime / duration;

        if (progress > 1) progress = 1;

        // ã‚¤ãƒ¼ã‚ºã‚¤ãƒ³ã®è¨ˆç®—
        let currentValue = startValue + (endValue - startValue) * (progress * progress);

        updateFunction(currentValue);

        if (progress < 1) requestAnimationFrame(animate);
      }

      requestAnimationFrame(animate);
    }

    //----------------------------------------
    // â–¼ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã®è¡¨ç¤ºé–¢æ•°
    //----------------------------------------

    const calculatePercentage = () => {
      // console.log("AGroupCount", AGroupCount, "BGroupCount", BGroupCount)
      let isFirstCall = true;

      // ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã®è¨ˆç®—
      const total = AGroupCount + BGroupCount;
      // console.log(total)
      AGroupPercentage = Math.round((AGroupCount / total) * 100); // å°æ•°ç‚¹ã‚’ä¸¸ã‚ã‚‹
      BGroupPercentage = 100 - AGroupPercentage;

      // AGroupPercentageã®æ–°ã—ã„å€¤ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      let newAGroupPercentage = Math.round((AGroupCount / total) * 100);

      easeInAnimation(previousAGroupPercentage, newAGroupPercentage, 1000, function (value) {
        document.getElementById("AGroupPercentage").innerHTML = `${Math.round(value)}<span id="Apercentage">%</span>`;
      });

      previousAGroupPercentage = newAGroupPercentage; // å‰å›ã®AGroupPercentageã‚’æ›´æ–°

      // BGroupPercentageã®æ–°ã—ã„å€¤ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      let newBGroupPercentage = 100 - newAGroupPercentage;

      easeInAnimation(previousBGroupPercentage, newBGroupPercentage, 1000, function (value) {
        document.getElementById("BGroupPercentage").innerHTML = `${Math.round(value)}<span id="Bpercentage">%</span>`;
      });

      previousBGroupPercentage = newBGroupPercentage; // å‰å›ã®BGroupPercentageã‚’æ›´æ–°

      // HTMLè¦ç´ ã«ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã‚’è¡¨ç¤º

      // document.getElementById("AGroupPercentage").innerHTML = `${AGroupPercentage}<span id="Apercentage">%</span>`;
      // document.getElementById("AGroupCount").innerHTML = `${AGroupCount}`;
      // document.getElementById("BGroupPercentage").innerHTML = `${BGroupPercentage}<span id="Bpercentage">%</span>`;
      // document.getElementById("BGroupCount").innerHTML = `${BGroupCount}`;
      // console.log("AGroupPercentage", AGroupPercentage);
      // console.log("BGroupPercentage", BGroupPercentage);

    }
    // drawImageOnCanvas(clickStamp);
    // drawBarGraph(AGroupPercentage, BGroupPercentage);
    // console.log(clickStamp, BGroupPercentage)

    //----------------------------------------
    // â–¼ã‚¹ã‚¿ãƒ³ãƒ—æç”»é–¢æ•°
    //----------------------------------------
    let isAnimationRunning = false;

    const GRAVITY = 0.03; // é‡åŠ›ã®å¼·ã•
    const FRICTION = 0.3; // æ‘©æ“¦ä¿‚æ•°
    // const CONSTANT_VELOCITY = 5;

    // clickStampãŒæ›´æ–°ã•ã‚ŒãŸã‚‰æç”»ã™ã‚‹ãŸã‚ã®é–¢æ•°
    // function drawImageOnCanvas(stampURL, stampType) {
    function drawImageOnCanvas(stampURL) {
      const image = document.createElement('img');
      image.className = "stampMoving";
      image.onload = () => {

        const randomValue = Math.random();

        // posXã‚’è¨ˆç®—
        let posX = rectX + Math.random() * rectWidth - (100 * (0.1 + randomValue * 0.4));

        // posXãŒrectXã‚ˆã‚Šå°ã•ã‘ã‚Œã°ã€æ–°ã—ã„å€¤ã‚’è¨ˆç®—ã™ã‚‹
        if (posX < rectX) {
          posX = rectX + Math.random() * rectWidth;
        }

        const stampInfo = {
          image: image,
          posX: posX,
          // posY: rectY - image.height,
          posY: rectY - (100 * (0.1 + randomValue * 0.4)),
          velocityX: 0,
          initialVelocityY: 0.1 + Math.random() * 1,
          velocityY: 0.3 + Math.random(),
          size: 100,
          sizeRate: 0.1 + randomValue * 0.4,
          isAnimating: true,
          opacity: 1.0,
        };
        // console.log("stampInfo", stampInfo);
        stamps.push(stampInfo);
        // console.log(stamps.length)

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
        if (!isAnimationRunning) {
          isAnimationRunning = true;
          animate();
          // console.log(stamps.length)
        }
      };
      image.src = stampURL; // clickStampsã«ç”»åƒã®URLã‚’æ ¼ç´
    };

    //----------------------------------------
    // ã‚¹ã‚¿ãƒ³ãƒ—ã®è·é›¢ã‚’æ¸¬ã‚‹é–¢æ•°
    //----------------------------------------

    function areStampsColliding(stamp1, stamp2) {
      const dx = stamp1.posX - stamp2.posX;
      const dy = stamp1.posY - stamp2.posY;
      const distance = Math.sqrt(dx * dx + dy * dy);
      return distance < (stamp1.size + stamp2.size) / 2;
    };

    //----------------------------------------
    // â–¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã®é–¢æ•°
    //----------------------------------------
    const animate = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height); // Canvasã‚’ã‚¯ãƒªã‚¢
      drawBarGraph(AGroupPercentage, BGroupPercentage); // ã“ã“ã§ã‚°ãƒ©ãƒ•ã‚’å†æç”»

      for (let i = 0; i < stamps.length; i++) {
        // ç”»é¢ã®åŠåˆ†ã«æ¥ãŸã‚‰é‡ãªã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
        if (stamps[i].posY > canvas.height / 3 * 2) {

          //----------------------------------------
          // â–¼ã‚¹ã‚¿ãƒ³ãƒ—ã®è¡çªé–¢æ•°
          //----------------------------------------
          for (let j = i + 1; j < stamps.length; j++) {
            if (areStampsColliding(stamps[i], stamps[j])) {

              // ã‚¹ã‚¿ãƒ³ãƒ—ãŒé‡ãªã‚‰ãªã„ã‚ˆã†ã«ä½ç½®ã‚’èª¿æ•´
              const dx = stamps[j].posX - stamps[i].posX;
              const dy = stamps[j].posY - stamps[i].posY;
              const distance = Math.sqrt(dx * dx + dy * dy);
              const overlap = (stamps[i].size / 2 + stamps[j].size / 2) - distance;

              // é‡ãªã£ã¦ã„ã‚‹è·é›¢ã«åŸºã¥ã„ã¦ä½ç½®ã‚’èª¿æ•´
              const adjustX = (dx / distance) * overlap;
              const adjustY = (dy / distance) * overlap;

              // ä½ç½®ã‚’èª¿æ•´
              const margin = 10;
              stamps[i].posX -= adjustX / margin;
              stamps[i].posY -= adjustY / margin;
              stamps[j].posX += adjustX / margin;
              stamps[j].posY += adjustY / margin;
            }
          }
        }



        //----------------------------------------
        // â–¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®é–¢æ•°
        //----------------------------------------
        const stamp = stamps[i];
        // console.log(stamps.length)
        // const newStampSize = stamp.size * 0.5; // ã‚¹ã‚¿ãƒ³ãƒ—ã®ã‚µã‚¤ã‚º
        // const newStampSize = stamp.size * (Math.random() * 0.5 + 0.5); // ã‚¹ã‚¿ãƒ³ãƒ—ã®ã‚µã‚¤ã‚º
        const newStampSize = stamp.size * stamp.sizeRate;

        if (stamp.isAnimating) {
          stamp.posX += stamp.velocityX;

          // ç”»é¢ã®ã‚ã‚‹ä½ç½®ã¾ã§ã®å ´åˆ
          if (stamp.posY <= (rectY + rectHeight) / 3 * 2) {
            // é€Ÿåº¦ã‚’ä¸€å®šã«ä¿ã¤ï¼ˆé©åˆ‡ãªä¸€å®šã®é€Ÿåº¦ã‚’è¨­å®šã™ã‚‹ï¼‰
            stamp.velocityY = stamp.initialVelocityY;
          } else {
            // ç”»é¢ã®ã‚ã‚‹ä½ç½®ã‚’è¶…ãˆãŸå ´åˆã€é‡åŠ›ã®å½±éŸ¿ã‚’å—ã‘ã¦åŠ é€Ÿã™ã‚‹
            stamp.velocityY += (1 + GRAVITY);
          }
          stamp.posY += stamp.velocityY;
          // stamp.posY += stamp.velocityY;
          // console.log([i], "å€‹ç›®ãŒã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­", stamps[i].velocityY)

          if (stamp.posY + newStampSize > rectY + rectHeight) {
            stamp.posY = rectY + rectHeight - newStampSize;  // ã‚¹ã‚¿ãƒ³ãƒ—ã®ä½ç½®ã‚’canvasã®ä¸‹ç«¯ã«å›ºå®š

            // è·³ã­è¿”ã‚‹æ™‚ã«æ‘©æ“¦ã®å½±éŸ¿ã‚’å—ã‘ã‚‹
            stamp.velocityY = -stamp.velocityY * FRICTION;

            // é€Ÿåº¦ãŒéå¸¸ã«å°ã•ã„å ´åˆã€æ­¢ã‚ã‚‹
            if (Math.abs(stamp.velocityY) < 0.5) {
              stamp.velocityY = 0;
              stamp.opacity -= 0.1;
              // setTimeout(() => {
              //     stamp.isAnimating = false;
              // }, 1000);

              // é€æ˜åº¦ãŒ0ã«ãªã£ãŸã‚‰ã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢
              if (stamp.opacity <= 0) {
                stamp.opacity = 0;
                stamp.isAnimating = false;
              }
            }
          }
          ctx.globalAlpha = stamp.opacity; // é€æ˜åº¦ã®è¨­å®š

          // ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æç”»
          // const visibleHeight = stamp.size - (stamp.posY < 0 ? -stamp.posY : 0);  // ç”»é¢å¤–ã«ã¯ã¿å‡ºã—ã¦ã„ã‚‹éƒ¨åˆ†ã®é«˜ã•
          const visibleHeight = stamp.size - (stamp.posY < rectY ? rectY - stamp.posY : 0);  // rectYã‚’è¶…ãˆã¦ã„ã‚‹éƒ¨åˆ†ã®é«˜ã•
          ctx.drawImage(
            stamp.image,
            0,
            stamp.size - visibleHeight,
            stamp.size, // ã‚½ãƒ¼ã‚¹ç”»åƒã®å¹…
            visibleHeight, // ã‚½ãƒ¼ã‚¹ç”»åƒã®é«˜ã•
            stamp.posX,
            stamp.posY < rectY ? rectY : stamp.posY, // posYãŒrectYæœªæº€ãªã‚‰rectYã‚’ä½¿ã†
            newStampSize, // å®›å…ˆã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã®å¹…
            newStampSize * (visibleHeight / stamp.size) // å®›å…ˆã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã®é«˜ã•
          );
          ctx.globalAlpha = 1.0;
        };
      };
      // console.log("ãƒ†ã‚¹ãƒˆdrawBarGraph")
      if (stamps.length > 0) {
        requestAnimationFrame(animate);
      }
    };

    //----------------------------------------
    // â–¼æ£’ã‚°ãƒ©ãƒ•ã®æç”»é–¢æ•°
    //----------------------------------------

    let currentAGroupHeight = 0;
    let currentBGroupHeight = 0;
    const lerpRate = 0.05;  // è£œå®Œç‡ã€‚0.05ã®ã‚ˆã†ãªå°ã•ã„å€¤ã§ã‚¹ãƒ ãƒ¼ã‚ºãªå¤‰åŒ–ã‚’å¾—ã‚‹
    let isFirstDraw = true;

    let imageA = document.createElement('img');
    imageA.src = './img/star_blue.jpg';

    let imageB = document.createElement('img');
    imageB.src = './img/star_red.jpg';
    // console.log(imageA);

    const drawBarGraph = (AGroupPercentage, BGroupPercentage) => {

      // console.log('å·¦ä¸‹ã®åº§æ¨™:', bottomLeft);
      // console.log('å³ä¸‹ã®åº§æ¨™:', bottomRight);

      //----------------------------------------
      // æ£’ã‚°ãƒ©ãƒ•ã®æç”»
      //----------------------------------------
      const barWidth = canvas.height / 6;

      const barX1 = canvas.width / 10.2;
      const barX2 = canvas.width - barWidth - barWidth;

      const maxCanvasPercentage = 0.5;  // ã“ã‚Œã¯canvas.heightã®50%ã‚’æ„å‘³ã—ã¾ã™ã€‚
      const targetAGroupHeight = calculateBarHeight(AGroupPercentage, maxCanvasPercentage, canvas.height);
      const targetBGroupHeight = calculateBarHeight(BGroupPercentage, maxCanvasPercentage, canvas.height);
      // console.log(currentAGroupHeight);

      // ç¾åœ¨ã®é«˜ã•ã‚’ç›®æ¨™ã®é«˜ã•ã«è¿‘ã¥ã‘ã‚‹
      if (isFirstDraw) {
        currentAGroupHeight = targetAGroupHeight;
        currentBGroupHeight = targetBGroupHeight;
        isFirstDraw = false;
      } else {
        currentAGroupHeight += (targetAGroupHeight - currentAGroupHeight) * lerpRate;
        currentBGroupHeight += (targetBGroupHeight - currentBGroupHeight) * lerpRate;
      }

      // Aã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒãƒ¼ã‚°ãƒ©ãƒ•ã®ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚’è¨­å®š
      let patternA = ctx.createPattern(imageA, 'repeat');
      ctx.fillStyle = patternA;
      // ctx.fillStyle = "#0000cc";
      ctx.fillRect(bottomLeftX, bottomLeftY, barWidth, -currentAGroupHeight);
      // console.log(barX1, canvas.height, barWidth, -currentAGroupHeight);

      let patternB = ctx.createPattern(imageB, 'repeat');
      ctx.fillStyle = patternB;
      // ctx.fillStyle = '#cc0000';
      ctx.fillRect(bottomRightX - barWidth, bottomRightY, barWidth, -currentBGroupHeight);

      // // èµ¤ã„å››è§’ã‚’æã
      // ctx.fillStyle = 'red';
      // ctx.fillRect(canvas.width / 10.2, canvas.height / 15, canvas.width / 1.265, canvas.height / 1.62);
    };

    const calculateBarHeight = (percentage, maxCanvasPercentage, canvasHeight) => {
      return (percentage / 100) * maxCanvasPercentage * canvasHeight;
    }

    //----------------------------------------
    // â–¼ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¼ãƒ­ã«ã™ã‚‹é–¢æ•°
    //----------------------------------------

    const resetCount = async () => {

      const querySnapshot = await getDocs(q)

      querySnapshot.forEach(async (doc) => {

        // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const docData = doc.data();

        // ã‚«ã‚¦ãƒ³ãƒˆã‚’0ã«è¨­å®š
        docData.count = 0;

        // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
        await updateDoc(doc.ref, docData);

      });
    };

    // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
    const resetButton = document.getElementById("resetButton");
    resetButton.addEventListener("click", resetCount);

    //----------------------------------------
    // â–¼ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹é–¢æ•°
    //----------------------------------------

    document.addEventListener('dblclick', function (e) {
      e.preventDefault();
    });

  </script>
</body>

</html>