<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>startup_kyushu</title>

  <!-- CSS & Tailwind -->
  <link rel="stylesheet" href="css/reset.css" />
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- fontAwesome -->
  <script src="https://kit.fontawesome.com/e6a146d4cb.js" crossorigin="anonymous"></script>

</head>

<body>
  <!----------------------------------------------
    â­ï¸ã‚¿ã‚¤ãƒˆãƒ«
    ------------------------------------------------->
  <section class="bg-gray-200">
    <div class="flex flex-col items-center justify-center px-4 pt-4 pb-4 mx-auto">
      <div class="w-full bg-white rounded-lg shadow sm:max-w-3xl md:w-4/5 xl:p-0">
        <div class="p-4 space-y-4 md:space-y-6 sm:p-8">
          <div>
            <a href="stamp_create.html">
              <img class="w-full h-15 mr-2" src="img/startup_kyushu.png" alt="logo" />
            </a>
            <div>
              <div class="text-lg font-bold m-2">
                # ã¿ã‚“ãªã§æŠ¼ã—ã¦ãƒ”ãƒƒãƒã‚’å¿œæ´ã—ã‚ˆã†ï¼
              </div>
              <div class="text-sm m-2">
                # ãƒ”ãƒƒãƒçµ‚äº†å¾Œã€æ°—ã«ãªã‚‹ç™»å£‡è€…ã¸ãŠæ°—è»½ã«ãŠå£°ãŒã‘ãã ã•ã„â™ª
              </div>
              <div class="canvas-wrapper">
                <img src="img/bg.jpeg" alt="Background Image">
                <canvas id="overlay"></canvas>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>
  </section>


  <!-- â­ï¸ã‚¹ã‚¿ãƒ³ãƒ—è¡¨ç¤ºã‚¨ãƒªã‚¢ -->


  <!----------------------------------------------
    â­ï¸ã‚¹ã‚¿ãƒ³ãƒ—è¡¨ç¤ºã‚¨ãƒªã‚¢  
    ------------------------------------------------->
  <div id="stampWrapper">
    <div id="stampListContainer" class="stampContainer"></div>
  </div>

  <!----------------------------------------------
    â­ï¸ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢  
    ------------------------------------------------->

  <!-- <section class="bg-gray-200">
    <div class="flex flex-col items-center justify-center px-4 pt-4 pb-4 mx-auto">
      <div class="w-full bg-white rounded-lg shadow sm:max-w-3xl md:w-4/5 xl:p-0">
        <div class="p-6 space-y-4 md:space-y-6 sm:p-8">
          <div class="flex flex-col items-center">
            <h2 class="text-xl font-semibold mb-2">ã‚¤ãƒ™ãƒ³ãƒˆç†±é‡</h2>
            <div id="userPoint" class="text-2xl font-bold userPoint"></div>
          </div>
        </div>
      </div>
    </div>
  </section> -->

  <script type="module">
    //------------------------------------------
    // â–¼firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨javaScriptã‚’é€£æºã•ã›ã‚‹
    //------------------------------------------

    // å¿…è¦ãªæ©Ÿèƒ½ã‚’SDKã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
    // import { initializeApp } from "firebase/compat/app";

    // firebase firestoreã¨ã‚„ã‚Šå–ã‚Šã‚’ã™ã‚‹è¨­å®š
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      query,
      orderBy, //ãƒ‡ãƒ¼ã‚¿ã®ã‚½ãƒ¼ãƒˆ
      onSnapshot, // Firestore ä¸Šã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      doc,
      deleteDoc,
      updateDoc,
      getDocs,
      getDoc,
      increment,
    } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";

    // firebase storageã¨ã‚„ã‚Šå–ã‚Šã‚’ã™ã‚‹è¨­å®š
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL,
    } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-storage.js";

    // ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®Firebaseã®è¨­å®š
    const firebaseConfig = {
      apiKey: "",
      authDomain: "tvcha-9cae7.firebaseapp.com",
      projectId: "tvcha-9cae7",
      storageBucket: "tvcha-9cae7.appspot.com",
      messagingSenderId: "866848033597",
      appId: "1:866848033597:web:c6887382eb14ee58351354",
    };

    // Firebaseã®åˆæœŸåŒ–
    const app = initializeApp(firebaseConfig);

    // Firebaseã‚¢ãƒ—ãƒªã¨Cloud Storageã®é€£æºã‚’åˆæœŸåŒ–ã—ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹
    const storage = getStorage(app);

    // dbã«å¯¾ã—ã¦ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ ã‚„å–å¾—ãŒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
    const db = getFirestore(app);

    // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®åå‰ã‚’å®šç¾©
    const collectionName = "alterbooth";
    const collectionUsernName = "alter-user";

    // ğŸ”½ ãƒ‡ãƒ¼ã‚¿å–å¾—æ¡ä»¶ã®æŒ‡å®šï¼ˆä»Šå›ã¯orderé †ã«ä¸¦ã³æ›¿ãˆã¦å–å¾—ï¼‰
    const q = query(collection(db, collectionName), orderBy("order", "desc"));

    // ğŸ”½ ãƒ‡ãƒ¼ã‚¿å–å¾—æ¡ä»¶ã®æŒ‡å®šï¼ˆä»Šå›ã¯orderé †ã«ä¸¦ã³æ›¿ãˆã¦å–å¾—ï¼‰
    const user_q = query(collection(db, collectionUsernName));

    // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¹ã‚¿ãƒ³ãƒ—ã®URLã‚’æ ¼ç´ã™ã‚‹é…åˆ—
    let clickStamp = "";
    const clickStamps = [];
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    const stamps = []; // ã‚¹ã‚¿ãƒ³ãƒ—ã®æƒ…å ±ã‚’ä¿æŒã™ã‚‹é…åˆ—
    //----------------------------------------
    // â–¼æœ€åˆã®ã‚¹ã‚¿ãƒ³ãƒ—ç”»åƒãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    //----------------------------------------

    const initialSnapshot = await getDocs(q);
    const initialArray = [];
    initialSnapshot.docs.forEach(function (doc) {
      const document = {
        id: doc.id,
        data: doc.data(),
      };
      initialArray.push(document);
    });
    const initialImageUrls = []; // imageUrlsã‚’åˆæœŸåŒ–ã—ã¦ãŠã
    const initialPointData = []; // pointDataã‚’åˆæœŸåŒ–ã—ã¦ãŠã

    initialArray.forEach(function (document, index) {
      // countDataã«document.data.countã‚’è¿½åŠ 
      initialPointData.push(document.data.point);
      // imageUrlsã«document.data.imgã‚’è¿½åŠ 
      initialImageUrls.push(document.data.img);
    });
    // console.log("initialArray", initialArray.length, "initialImageUrls", initialImageUrls, "initialPointData", initialPointData);

    const stampListContainer = document.getElementById('stampListContainer');

    //----------------------------------------
    // â–¼ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    //----------------------------------------

    const imageElements = [];

    function renderImages() {
      stampListContainer.innerHTML = '';

      initialImageUrls.forEach((imageUrl, index) => {
        const imageWrapper = document.createElement('div');
        imageWrapper.className = 'image-wrapper';

        const imageElement = document.createElement('img');
        imageElement.src = imageUrl;
        imageElement.className = 'image';
        imageElements.push(imageElement)


        imageWrapper.appendChild(imageElement);
        const pointElement = document.createElement('div');
        pointElement.textContent = `${initialPointData[index]}`;
        pointElement.className = 'point';
        imageWrapper.appendChild(pointElement);

        stampListContainer.appendChild(imageWrapper);
      });
    }
    renderImages();

    console.log("imageElements", imageElements);

    //----------------------------------------
    // â–¼æœ€åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    //----------------------------------------

    const initialUserSnapshot = await getDocs(user_q);
    const initialUserArray = [];
    initialUserSnapshot.docs.forEach(function (doc) {
      const document = {
        id: doc.id,
        data: doc.data(),
      };
      initialUserArray.push(document);
    });

    console.log("initialUserArray", initialUserArray);

    //----------------------------------------
    // â–¼ã‚¹ã‚¿ãƒ³ãƒ—ã‚¯ãƒªãƒƒã‚¯é–¢æ•°ã€ãƒã‚¤ãƒ³ãƒˆåŠ ç®—é–¢æ•°
    //----------------------------------------
    const stampClick = async (stampId, userId) => {

      const clickedStamp = await getDoc(doc(db, collectionName, stampId));
      // console.log(clickedStamp);

      // const clickedCount = clickedStamp.data().count //ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¹ã‚¿ãƒ³ãƒ—ã®ãã‚Œã¾ã§ã®ã‚¯ãƒªãƒƒã‚¯æ•°
      const consumptionPoint = clickedStamp.data().point //ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¹ã‚¿ãƒ³ãƒ—ã®æ¶ˆè²»ãƒã‚¤ãƒ³ãƒˆ

      // Firebaseã®ã‚¯ãƒªãƒƒã‚¯æ•°ã‚’ä¸€ã¤å¢—ã‚„ã™
      await updateDoc(doc(db, collectionName, stampId), {
        count: increment(1)
      });

      // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®pointã‚’ä½¿ç”¨ã—ã¦æ›´æ–°
      await updateDoc(doc(db, collectionUsernName, userId), {
        point: increment(consumptionPoint)
      });
      console.log("ã‚«ã‚¦ãƒ³ãƒˆãŒæ­£å¸¸ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸã‚ˆã€‚");

    };

    //----------------------------------------
    // â–¼ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¹ã‚¿ãƒ³ãƒ—ã®IDã‚’å–å¾—ã™ã‚‹é–¢æ•°
    //----------------------------------------

    let isClickDisabled = false; // ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹ãƒ•ãƒ©ã‚°

    // ç”»åƒè¦ç´ ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    imageElements.forEach((imageElement, index) => {
      imageElement.addEventListener('click', () => {

        // if (isClickDisabled) {
        //   return; // ã‚¯ãƒªãƒƒã‚¯ãŒç„¡åŠ¹ãªã‚‰ä½•ã‚‚ã—ãªã„
        // };

        const stampId = initialArray[index].id; // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®IDã‚’å–å¾—
        const userId = initialUserArray[0].id; // arrayUserã®æœ€åˆã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®IDã‚’å–å¾—
        // console.log(stampId, userId)

        // ã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„ã‚¹ã‚¿ãƒ³ãƒ—ã®é€æ˜åº¦ã‚’50%ã«è¨­å®š
        // imageElements.forEach((otherImageElement, otherIndex) => {
        //   if (otherIndex !== index) {
        //     otherImageElement.style.opacity = '0.3';
        //   }
        // });


        // setTimeout(() => {
        // stampIdã¨userIdã‚’æ¸¡ã—ã¦å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ï¼ˆ1ç§’å¾Œã«å®Ÿè¡Œï¼‰
        stampClick(stampId, userId);
        // }, 1000); // 1000ãƒŸãƒªç§’ï¼ˆ1ç§’ï¼‰å¾Œã«å®Ÿè¡Œ

        // ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®æŒ™å‹•
        imageElement.classList.add('clicked-image'); // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‰ 'clicked-image' ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
        isClickDisabled = true; // ã‚¯ãƒªãƒƒã‚¯ã‚’ç„¡åŠ¹åŒ–

        setTimeout(() => {
          imageElement.classList.remove('clicked-image'); // ä¸€å®šæ™‚é–“çµŒéå¾Œã« 'clicked-image' ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
          isClickDisabled = false; // ä¸€å®šæ™‚é–“å¾Œã«ã‚¯ãƒªãƒƒã‚¯ã‚’å†åº¦æœ‰åŠ¹ã«ã™ã‚‹
          // imageElements.forEach((otherImageElement, otherIndex) => {
          //   if (otherIndex !== index) {
          //     otherImageElement.style.opacity = '1';
          //   }
          // });
        }, 2000);

        // console.log(imageElements[clickedStampIndex]);

      });
    });

    //----------------------------------------
    // â–¼å¤‰æ›´ãƒœã‚¿ãƒ³é–¢æ•°
    //----------------------------------------

    // ç”»åƒã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ URL ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹ãŸã‚ã®é–¢æ•°
    function displayImage(downloadURL, element) {
      // ã™ã§ã«ç”»åƒãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å‰Šé™¤ã™ã‚‹
      while (element.firstChild) {
        element.removeChild(element.firstChild);
      }

      // æ–°ã—ã„ç”»åƒã‚’è¡¨ç¤º
      const img = document.createElement("img");
      img.src = downloadURL;
      element.appendChild(img);
    };



    //----------------------------------------
    // â–¼ãƒ‡ãƒ¼ã‚¿å–å¾—å‡¦ç†(ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸Šã§ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ãŒç™ºç”Ÿã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ {} å†…ã®å‡¦ç†ã‚’å®Ÿè¡Œ)
    //----------------------------------------

    // onSnapshot(q, (querySnapshot) => {
    // const array = [];
    // querySnapshot.docs.forEach(function (doc) {
    //   const document = {
    //     id: doc.id,
    //     data: doc.data(),
    //   };
    //   array.push(document);
    // });

    // const imageUrls = []; // imageUrlsã‚’åˆæœŸåŒ–ã—ã¦ãŠã
    // const pointData = []; // pointDataã‚’åˆæœŸåŒ–ã—ã¦ãŠã
    // const countData = []; // countDataã‚’åˆæœŸåŒ–ã—ã¦ãŠã
    // const arrayUser = []; // arrayUserã‚’åˆæœŸåŒ–ã—ã¦ãŠã
    // //----------------------------------------
    // // id: 'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ID',
    // // data: {
    // //      img: 'ç”»åƒã®URL',
    // //      point: 'ãƒã‚¤ãƒ³ãƒˆ',
    // //      count: 'ã‚«ã‚¦ãƒ³ãƒˆ',
    // //      time: 'ä½œæˆæ—¥æ™‚ãªã©'
    // // countData : 'ã‚«ã‚¦ãƒ³ãƒˆã®é…åˆ—',
    // // imageUrls : 'ç”»åƒã®URLã®é…åˆ—'
    // //----------------------------------------

    // array.forEach(function (document, index) {

    //   // countDataã«document.data.countã‚’è¿½åŠ 
    //   pointData.push(document.data.point);

    //   // countDataã«document.data.countã‚’è¿½åŠ 
    //   countData.push(document.data.count);

    //   // imageUrlsã«document.data.imgã‚’è¿½åŠ 
    //   imageUrls.push(document.data.img);

    // });

    //----------------------------------------
    // â–¼ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«handlestampClické–¢æ•°ã€clickStampPointé–¢æ•°ã‚’å‘¼ã³å‡ºã™
    //----------------------------------------
    // imageElements.forEach((imageElement, index) => {
    //   imageElement.addEventListener('click', () => {
    //     const stampId = array[index].id; // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®IDã‚’å–å¾—
    //     const userId = arrayUser[0].id; // arrayUserã®æœ€åˆã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®IDã‚’å–å¾—
    //     console.log(stampId, userId)

    //     // stampIdã¨userIdã‚’æ¸¡ã—ã¦å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹
    //     stampClick(stampId, userId);

    //     // ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®æŒ™å‹•
    //     imageElement.classList.add('clicked-image'); // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‰ 'clicked-image' ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
    //     setTimeout(() => {
    //       imageElement.classList.remove('clicked-image'); // ä¸€å®šæ™‚é–“çµŒéå¾Œã« 'clicked-image' ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
    //     }, 300);
    //   });
    // });

    // ----------------------------------------
    //   â–¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒã‚¤ãƒ³ãƒˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    // ----------------------------------------
    //   æœ€åˆã«ãƒªã‚¹ãƒŠãƒ¼ã‚’å¤‰æ•°ã«æ ¼ç´
    // onSnapshot(user_q, (querySnapshot) => {
    //   arrayUser.length = 0; // é…åˆ—ã‚’ã‚¯ãƒªã‚¢ã—ã¦æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ 

    //   querySnapshot.docs.forEach(function (doc) {
    //     const document = {
    //       id: doc.id,
    //       data: doc.data(),
    //     };
    //     arrayUser.push(document);
    //   });

    //   // console.log("arrayUser", arrayUser)
    //   // console.log("userHavePoint:", arrayUser[1].data.point);

    //   const userPointElement = document.getElementById('userPoint');
    //   if (userPointElement) {
    //     userPointElement.textContent = arrayUser[0].data.point;
    //   }
    //   console.log(userPointElement)
    // });

    // console.log("pointData", pointData);
    // console.log("countData", countData);
    // console.log(imageUrls);

    // });

    //----------------------------------------
    // â–¼canvasèƒŒæ™¯ã®ç”»åƒã®å¤§ãã•ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    //----------------------------------------
    let canvasImage = document.querySelector('.canvas-wrapper img');

    // ç”»åƒãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰ã€ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’è¨­å®šã™ã‚‹
    canvasImage.addEventListener('load', function () {
      canvas.width = canvasImage.width;
      canvas.height = canvasImage.height;
    });

    // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒãƒªã‚µã‚¤ã‚ºã•ã‚ŒãŸã¨ãã‚‚ã€ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’å†è¨­å®šã™ã‚‹
    window.addEventListener('resize', function () {
      canvas.width = canvasImage.width;
      canvas.height = canvasImage.height;
    });

    // ç”»åƒãŒã™ã§ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆã®å¯¾å‡¦
    if (canvasImage.complete) {
      canvas.width = canvasImage.width;
      canvas.height = canvasImage.height;
    }
    // // åˆæœŸã‚µã‚¤ã‚ºè¨­å®š
    // updateCanvasSize();

    // // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ãƒªã‚µã‚¤ã‚ºã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–
    // window.addEventListener('resize', updateCanvasSize);

    // // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®å¤§ãã•ã«åˆã‚ã›ã¦è¨­å®š
    // function updateCanvasSize() {
    //   canvas.width = window.innerWidth;
    //   canvas.height = window.innerHeight;
    //   // console.log(canvas.width, canvas.height)
    //   // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®å†æç”»ãªã©è¿½åŠ ã®å‡¦ç†ãŒå¿…è¦ãªå ´åˆã€ã“ã“ã§è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
    // };

    // ãƒ‡ãƒ¼ã‚¿å–å¾—å‡¦ç†(ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸Šã§ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ãŒç™ºç”Ÿã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ {} å†…ã®å‡¦ç†ã‚’å®Ÿè¡Œ)
    onSnapshot(q, (querySnapshot) => {

      querySnapshot.docChanges().forEach((change) => {
        if (change.type === "modified") {
          // console.log("ã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");
          const clickStamp = change.doc.data().img;
          // clickStamps.push(clickStamp);
          // console.log("ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¹ã‚¿ãƒ³ãƒ—é…åˆ—", clickStamps);
          // console.log("ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¹ã‚¿ãƒ³ãƒ—", clickStamp);
          // ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ãŸå¾Œã€2ç§’å¾Œã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã™ã‚‹
          // setTimeout(() => {
          drawImageOnCanvas(clickStamp);
          // console.log(clickStamp);
          // }, 1000);
        }
      });
    });

    //----------------------------------------
    // â–¼åŸºæœ¬ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®š
    //----------------------------------------
    // const targetX = (canvas.width) / 2// ç”»é¢ä¸­å¤®ã®Xåº§æ¨™
    const targetX = Math.random() * canvas.width;
    // const variance = canvas.width / 40;  // ã“ã‚Œã¯ã©ã‚Œãã‚‰ã„å¤‰å‹•ã™ã‚‹ã‹ã®ç¯„å›²ã‚’æŒ‡å®šã—ã¾ã™ã€‚ã“ã®å ´åˆã€ç”»é¢ã®1/4ã®ç¯„å›²ã§å¤‰å‹•ã—ã¾ã™ã€‚
    // const targetX = canvas.width / 2 + (Math.random() - 0.5) * 2 * canvas.width / 40;  // ç”»é¢ä¸­å¤®ã®Xåº§æ¨™ã‚’åŸºç‚¹ã«ãƒ©ãƒ³ãƒ€ãƒ ãªå€¤ã‚’åŠ ãˆã‚‹

    const targetY = (canvas.height) / 2; // ç”»é¢ä¸­å¤®ã®Yåº§æ¨™
    const maxSize = 200; // æœ€å¤§ã‚µã‚¤ã‚º
    let friction = 0.95; // æ‘©æ“¦ä¿‚æ•°
    const initialGrowthRate = 2; // åˆæœŸã®æˆé•·ç‡

    //----------------------------------------
    // â–¼æ‘©æ“¦ä¿‚æ•°
    //----------------------------------------

    //----------------------------------------
    // â–¼ã‚¹ã‚¿ãƒ³ãƒ—æç”»é–¢æ•°
    //----------------------------------------
    let isAnimationRunning = false;

    // clickStampãŒæ›´æ–°ã•ã‚ŒãŸã‚‰æç”»ã™ã‚‹ãŸã‚ã®é–¢æ•°
    function drawImageOnCanvas(stampURL) {

      const image = document.createElement('img');
      image.onload = function () {
        //----------------------------------------
        // â–¼ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é…åˆ—ã«å…¥ã‚Œã‚‹
        //----------------------------------------

        let posX, posY, velocityX;

        if (Math.random() < 0.5) {
          posX = 0;
          // velocityX = 10;

          const velocities = [1, 2, 4, 6, 0];
          const randomIndex = Math.floor(Math.random() * velocities.length);
          velocityX = velocities[randomIndex];

          posY = Math.random() * canvas.height / 4 * 3;
        }
        else {
          posX = canvas.width;
          // ãƒ©ãƒ³ãƒ€ãƒ ãªé€Ÿåº¦ã‚’è¨­å®š

          const velocities = [-3, -5, -7, -9, -11];
          const randomIndex = Math.floor(Math.random() * velocities.length);
          velocityX = velocities[randomIndex];
          // velocityX = -45;

          posY = Math.random() * canvas.height / 4 * 3;
        }

        console.log(velocityX)
        const stampInfo = {
          image: image,
          posX: posX,
          posY: posY,
          velocityX: velocityX,
          velocityY: 0,
          size: 0,
          alpha: 1.0,
          isAnimating: true,
        };
        stamps.push(stampInfo);
        // console.log(stamps)

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
        if (!isAnimationRunning) {
          isAnimationRunning = true;
          animate();
        }
      };
      image.src = stampURL; // clickStampsã«ç”»åƒã®URLã‚’æ ¼ç´
    };
    //----------------------------------------
    // â–¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®é–¢æ•°
    //----------------------------------------

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
    // animate();

    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height); // Canvasã‚’ã‚¯ãƒªã‚¢

      // é€Ÿåº¦ã‚’æ›´æ–°
      for (let i = 0; i < stamps.length; i++) {
        const stamp = stamps[i];

        if (stamp.isAnimating) {
          stamp.velocityX *= friction; // æ‘©æ“¦ã‚’é©ç”¨
          stamp.velocityY *= friction; // æ‘©æ“¦ã‚’é©ç”¨
          // console.log("èª­ã¿è¾¼ã¿")
          // ä½ç½®ã‚’æ›´æ–°
          stamp.posX += stamp.velocityX; // é€Ÿåº¦ã«ã‚ˆã‚‹ä½ç½®ã®å¤‰åŒ–
          stamp.posY += stamp.velocityY; // é€Ÿåº¦ã«ã‚ˆã‚‹ä½ç½®ã®å¤‰åŒ–

          // ã‚µã‚¤ã‚ºã‚’æ›´æ–°
          const distanceToTarget = Math.sqrt((targetX - stamp.posX) ** 2 + (targetY - stamp.posY) ** 2);
          const growthRate = initialGrowthRate * (1 + distanceToTarget / canvas.width); // è·é›¢ã«å¿œã˜ã¦æˆé•·ç‡ã‚’èª¿æ•´

          // ã‚µã‚¤ã‚ºã‚’æ›´æ–°
          if (stamp.size < 150) {
            stamp.size += growthRate; // æˆé•·ç‡ã«ã‚ˆã‚‹ã‚µã‚¤ã‚ºã®å¢—åŠ 
          } else if (stamp.size >= 150 && stamp.size < maxSize) {
            stamp.size += growthRate; // 400ã‹ã‚‰500ã®é–“ã‚‚æˆé•·ã‚’ç¶šã‘ã‚‹
            stamp.alpha -= 0.05; // é€æ˜åº¦ã‚’ä¸‹ã’ã‚‹
          }
          ctx.globalAlpha = stamp.alpha;

          // ã‚¹ã‚¿ãƒ³ãƒ—ã®ä¸­å¤®åº§æ¨™ã‚’è¨ˆç®—
          const centerX = stamp.posX + stamp.size / 2;
          const centerY = stamp.posY + stamp.size / 2;

          // ã‚¹ã‚¿ãƒ³ãƒ—ã®ä¸­å¤®åº§æ¨™ã‚’ä¸­å¿ƒã«æç”»
          ctx.drawImage(stamp.image, centerX - stamp.size / 2, centerY - stamp.size / 2, stamp.size, stamp.size);

          if (stamp.alpha <= 0 || stamp.size > 200) {
            stamp.alpha = 0; // é€æ˜åº¦ãŒ-10ã®ã¾ã¾ã‚­ãƒ¼ãƒ—ã™ã‚‹
            // stamps.shift(); // é…åˆ—ã®å…ˆé ­ã‹ã‚‰å‰Šé™¤
            // console.log(stamp.size, stamp.alpha)
            // console.log("é…åˆ—ã®å…ˆé ­ã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ", stamps);

            stamp.isAnimating = false;
          };
        };
      }
      if (stamps.length > 0) {
        requestAnimationFrame(animate);
      }
    };


  </script>
</body>

</html>