<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>startup_kyushu</title>

  <!-- CSS & Tailwind -->
  <!-- <link rel="stylesheet" href="css/reset.css" /> -->
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- fontAwesome -->
  <script src="https://kit.fontawesome.com/e6a146d4cb.js" crossorigin="anonymous"></script>

</head>

<body>
  <!----------------------------------------------
    ⭐️タイトル
    ------------------------------------------------->
  <section class="bg-gray-200">
    <div class="flex flex-col items-center justify-center px-2 pt-2 pb-2">
      <div class="canvas-wrapper relative">
        <img src="img/bg.jpeg" class="rounded-lg">

        <a href="stamp_create.html" class="absolute top-4 left-4">
          <img src="img/startup_kyushu_logo.png" class="w-1/2 mr-2" />
        </a>

        <canvas id="overlay"></canvas>

        <div class="absolute bottom-2 left-4">
          <div class="text-lg font-bold m-0 text-white overflow-hidden whitespace-nowrap truncate">
            みんなで押してピッチを応援しよう！
          </div>
          <div class="text-sm m-0 text-white overflow-hidden whitespace-nowrap truncate">
            ピッチ終了後、気になる登壇者へお気軽にお声がけください♪
          </div>
        </div>
      </div>
    </div>
  </section>

  <!----------------------------------------------
    ⭐️スタンプ表示エリア  
    ------------------------------------------------->
  <div id="stampWrapper">
    <div id="stampListContainer" class="stampContainer"></div>
  </div>

  <!----------------------------------------------
    ⭐️ピッチ登壇者切り替えボタン
    ------------------------------------------------->
  <button data-id="1">1</button>
  <button data-id="2">2</button>
  <button data-id="3">3</button>
  <button data-id="4">4</button>
  <button data-id="5">5</button>
  <button data-id="6">6</button>
  <button data-id="7">7</button>
  <button data-id="8">8</button>
  <button data-id="9">9</button>
  <div id="stampSelections"></div>

  <div id="personWrapper" style="position: relative;">
    <img src="img/05.png" style="position: absolute; bottom: 0;" />
  </div>

  <!----------------------------------------------
    ⭐️ポイント表示エリア  
    ------------------------------------------------->

  <!-- <section class="bg-gray-200">
    <div class="flex flex-col items-center justify-center px-4 pt-4 pb-4 mx-auto">
      <div class="w-full bg-white rounded-lg shadow sm:max-w-3xl md:w-4/5 xl:p-0">
        <div class="p-6 space-y-4 md:space-y-6 sm:p-8">
          <div class="flex flex-col items-center">
            <h2 class="text-xl font-semibold mb-2">イベント熱量</h2>
            <div id="userPoint" class="text-2xl font-bold userPoint"></div>
          </div>
        </div>
      </div>
    </div>
  </section> -->

  <script type="module">
    //------------------------------------------
    // ▼firebaseプロジェクトとjavaScriptを連携させる
    //------------------------------------------

    // 必要な機能をSDKからインポート
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
    // import { initializeApp } from "firebase/compat/app";

    // firebase firestoreとやり取りをする設定
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      query,
      orderBy, //データのソート
      onSnapshot, // Firestore 上に保存されているデータを取得
      doc,
      deleteDoc,
      updateDoc,
      getDocs,
      getDoc,
      increment,
    } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";

    // firebase storageとやり取りをする設定
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL,
    } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-storage.js";

    // ウェブアプリのFirebaseの設定
    const firebaseConfig = {
      apiKey: "",
      authDomain: "tvcha-9cae7.firebaseapp.com",
      projectId: "tvcha-9cae7",
      storageBucket: "tvcha-9cae7.appspot.com",
      messagingSenderId: "866848033597",
      appId: "1:866848033597:web:c6887382eb14ee58351354",
    };

    // Firebaseの初期化
    const app = initializeApp(firebaseConfig);

    // FirebaseアプリとCloud Storageの連携を初期化しセットアップする
    const storage = getStorage(app);

    // dbに対してデータの追加や取得ができるようにする
    const db = getFirestore(app);

    // コレクションの名前を定義
    const collectionName = "startup_kyushu2023";
    const collectionUsernName = "alter-user";

    // 🔽 データ取得条件の指定（今回はorder順に並び替えて取得）
    const q = query(collection(db, collectionName), orderBy("order", "desc"));

    // 🔽 データ取得条件の指定（今回はorder順に並び替えて取得）
    const user_q = query(collection(db, collectionUsernName));

    // クリックされたスタンプのURLを格納する配列
    let clickStamp = "";
    const clickStamps = [];
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    const stamps = []; // スタンプの情報を保持する配列
    //----------------------------------------
    // ▼最初のスタンプ画像データの読み込み
    //----------------------------------------

    const initialSnapshot = await getDocs(q);
    const initialArray = [];
    initialSnapshot.docs.forEach(function (doc) {
      const document = {
        id: doc.id,
        data: doc.data(),
      };
      initialArray.push(document);
    });
    const initialImageUrls = []; // imageUrlsを初期化しておく
    const initialPointData = []; // pointDataを初期化しておく

    initialArray.forEach(function (document, index) {
      // countDataにdocument.data.countを追加
      initialPointData.push(document.data.point);
      // imageUrlsにdocument.data.imgを追加
      initialImageUrls.push(document.data.img);
    });
    // console.log("initialArray", initialArray.length, "initialImageUrls", initialImageUrls, "initialPointData", initialPointData);

    const stampListContainer = document.getElementById('stampListContainer');

    //----------------------------------------
    // ▼スタンプを表示する関数
    //----------------------------------------

    const imageElements = [];
    const margin = 10;

    const renderImages = () => {
      stampListContainer.innerHTML = '';

      const imageWidth = (window.innerWidth - 5 * margin) / 3;
      console.log(window.innerWidth, imageWidth);

      initialImageUrls.forEach((imageUrl, index) => {
        const imageWrapper = document.createElement('div');
        imageWrapper.className = 'image-wrapper';
        imageWrapper.style.marginRight = index !== 2 ? `${margin}px` : '0px';

        const imageElement = document.createElement('img');
        imageElement.src = imageUrl;
        imageElement.className = 'image';
        imageElement.style.maxWidth = `${imageWidth}px`;
        imageElements.push(imageElement)

        imageWrapper.appendChild(imageElement);

        const pointElement = document.createElement('div');
        pointElement.textContent = `${initialPointData[index]}`;
        pointElement.className = 'point';
        imageWrapper.appendChild(pointElement);

        stampListContainer.appendChild(imageWrapper);
      });
    }
    renderImages();
    window.addEventListener('resize', renderImages);

    // console.log("imageElements", imageElements);

    //----------------------------------------
    // ▼スタンプをクリックできなくする関数
    //----------------------------------------

    const addNeverClickableClass = (btnId) => {
      if (!btnId) {
        btnId = localStorage.getItem("lastClicked");
      }

      // ローカルストレージから直近に押したボタンとstampSelectionsを取得
      const index = localStorage.getItem("lastClicked");
      const storedStates = JSON.parse(localStorage.getItem("stampSelections") || '[]');
      // console.log(btnId, index);

      if (storedStates[btnId - 1] !== null) {
        console.log("このスタンプは押せません");
        const targetElements = document.querySelectorAll('.image');

        targetElements.forEach((targetElement) => {
          targetElement.classList.add('never-clickable');
          targetElement.classList.remove('image');
        });
      } else if (storedStates[btnId - 1] === null) {
        const targetElements = document.querySelectorAll('.never-clickable');

        targetElements.forEach((targetElement) => {
          targetElement.classList.add('image');
          targetElement.classList.remove('never-clickable');
        });
      };
    };

    //----------------------------------------
    // ▼ピッチ登壇者ボタンのイベントリスナを設定する
    //----------------------------------------
    // ボタンを押したらローカルストレージに直近におした番号を保存し、押したボタンをハイライト表示
    // さらにスタンプを押していたら押せないようにする
    const initializeButtons = () => {
      const buttons = document.querySelectorAll("button");

      buttons.forEach((button) => {
        const btnId = button.getAttribute("data-id");
        button.addEventListener("click", () => {
          storeLastClicked(btnId);
          highlightButton(btnId);
          addNeverClickableClass(btnId);
        });
      });
    };

    //----------------------------------------
    // ▼ローカルストレージに直近におした番号を保存
    //----------------------------------------
    const storeLastClicked = (btnId) => {
      if (!btnId) {
        btnId = localStorage.getItem("lastClicked") || "1";
      }
      localStorage.setItem("lastClicked", btnId);
    };

    //----------------------------------------
    // ▼押したボタンをハイライト表示
    //----------------------------------------
    const highlightButton = (btnId) => {
      // もしbtnIdが渡されていない場合、LocalStorageから取得
      if (!btnId) {
        btnId = localStorage.getItem("lastClicked");
      }

      const buttons = document.querySelectorAll("button");
      buttons.forEach((button) => {
        button.style.background = button.getAttribute("data-id") === btnId ? "lightgray" : "";
      });
    }

    //----------------------------------------
    // ▼ローカルストレージにどのボタン番号でどのスタンプを押したか保存する関数
    //----------------------------------------
    const stampButtonClicked = (btnId, stampId) => {
      const storedStates = JSON.parse(localStorage.getItem("stampSelections") || '[]');

      while (storedStates.length < 9) {
        storedStates.push(null);
      }

      storedStates[btnId - 1] = stampId;
      localStorage.setItem("stampSelections", JSON.stringify(storedStates));
    };

    //----------------------------------------
    // ▼作業用の表示関数
    //----------------------------------------
    const displayStampSelections = () => {
      // LocalStorageからstampSelectionsを取得して配列としてパースする
      const storedStates = JSON.parse(localStorage.getItem("stampSelections") || '[]');

      // 新しいテーブル要素を作成する
      const table = document.createElement("table");
      const tbody = document.createElement("tbody");

      storedStates.forEach((item, index) => {
        const row = document.createElement("tr");

        // Indexのセルを作成して追加
        const indexCell = document.createElement("td");
        indexCell.textContent = `${index + 1}:`;
        row.appendChild(indexCell);

        // 値のセルを作成して追加
        const valueCell = document.createElement("td");
        valueCell.textContent = item === null ? "null" : item;
        row.appendChild(valueCell);

        tbody.appendChild(row);
      });

      table.appendChild(tbody);

      // <div id="stampSelections"></div>の内容をクリア
      const container = document.getElementById("stampSelections");
      container.innerHTML = '';

      // 新しいテーブルを<div id="stampSelections"></div>に追加する
      container.appendChild(table);
    };
    //----------------------------------------
    // ▼初回読み込み時の挙動
    //----------------------------------------

    initializeButtons();
    storeLastClicked();
    stampButtonClicked();
    highlightButton();
    addNeverClickableClass();
    displayStampSelections();

    //----------------------------------------
    // ▼登壇者の画像を表示する
    //----------------------------------------

    const viewportHeight = window.innerHeight;
    console.log(viewportHeight);
    const personWrapper = document.getElementById('personWrapper');
    personWrapper.style.height = viewportHeight + 'px';

    //----------------------------------------
    // ▼最初のユーザーデータ読み込み
    //----------------------------------------

    const initialUserSnapshot = await getDocs(user_q);
    const initialUserArray = [];
    initialUserSnapshot.docs.forEach(function (doc) {
      const document = {
        id: doc.id,
        data: doc.data(),
      };
      initialUserArray.push(document);
    });

    //----------------------------------------
    // ▼スタンプクリック関数、ポイント加算関数
    //----------------------------------------
    const stampClick = async (stampId, userId) => {

      // ローカルストレージから直近に押したボタンとstampSelectionsを取得
      const btnId = localStorage.getItem("lastClicked");
      const storedStates = JSON.parse(localStorage.getItem("stampSelections") || '[]');

      // ボタンのイベントリスナを初期化
      initializeButtons();
      stampButtonClicked(btnId, stampId);
      addNeverClickableClass(btnId);
      displayStampSelections();

      console.log("index", btnId, "クリックID", storedStates[btnId - 1]);

      const clickedStamp = await getDoc(doc(db, collectionName, stampId));

      // const clickedCount = clickedStamp.data().count //クリックされたスタンプのそれまでのクリック数
      const consumptionPoint = clickedStamp.data().point //クリックされたスタンプの消費ポイント

      // Firebaseのクリック数を一つ増やす
      await updateDoc(doc(db, collectionName, stampId), {
        count: increment(1)
      });

      // ドキュメントのpointを使用して更新
      await updateDoc(doc(db, collectionUsernName, userId), {
        point: increment(consumptionPoint)
      });
    };

    //----------------------------------------
    // ▼クリックされたスタンプのIDを取得する関数
    //----------------------------------------

    // 画像要素にクリックイベントリスナーを追加
    imageElements.forEach((imageElement, index) => {
      imageElement.addEventListener('click', () => {

        const stampId = initialArray[index].id; // クリックされたドキュメントのIDを取得
        const userId = initialUserArray[0].id; // arrayUserの最初のドキュメントのIDを取得
        stampClick(stampId, userId);

        // ボタンが押された時の挙動
        imageElement.classList.add('clicked-image'); // クリックされたら 'clicked-image' クラスを追加

        setTimeout(() => {
          imageElement.classList.remove('clicked-image'); // 一定時間経過後に 'clicked-image' クラスを削除
        }, 2000);
      });
    });

    //----------------------------------------
    // ▼変更ボタン関数
    //----------------------------------------

    // 画像のダウンロード URL を取得して表示するための関数
    function displayImage(downloadURL, element) {
      // すでに画像が表示されている場合は削除する
      while (element.firstChild) {
        element.removeChild(element.firstChild);
      }

      // 新しい画像を表示
      const img = document.createElement("img");
      img.src = downloadURL;
      element.appendChild(img);
    };

    //----------------------------------------
    // ▼canvas背景の画像の大きさを取得する関数
    //----------------------------------------
    let canvasImage = document.querySelector('.canvas-wrapper img');

    // 画像が読み込まれたら、キャンバスのサイズを設定する
    canvasImage.addEventListener('load', function () {
      canvas.width = canvasImage.width;
      canvas.height = canvasImage.height;
    });

    // ウィンドウがリサイズされたときも、キャンバスのサイズを再設定する
    window.addEventListener('resize', function () {
      canvas.width = canvasImage.width;
      canvas.height = canvasImage.height;
    });

    // 画像がすでに読み込まれている場合の対処
    if (canvasImage.complete) {
      canvas.width = canvasImage.width;
      canvas.height = canvasImage.height;
    }

    // データ取得処理(データベース上でデータの変更が発生したタイミングで {} 内の処理を実行)
    onSnapshot(q, (querySnapshot) => {
      querySnapshot.docChanges().forEach((change) => {
        if (change.type === "modified") {
          const clickStamp = change.doc.data().img;
          drawImageOnCanvas(clickStamp);

        }
      });
    });

    //----------------------------------------
    // ▼基本パラメータを設定
    //----------------------------------------
    // const targetX = (canvas.width) / 2// 画面中央のX座標
    const targetX = Math.random() * canvas.width;
    // const variance = canvas.width / 40;  // これはどれくらい変動するかの範囲を指定します。この場合、画面の1/4の範囲で変動します。
    // const targetX = canvas.width / 2 + (Math.random() - 0.5) * 2 * canvas.width / 40;  // 画面中央のX座標を基点にランダムな値を加える

    const targetY = (canvas.height) / 2; // 画面中央のY座標
    const maxSize = 200; // 最大サイズ
    let friction = 0.95; // 摩擦係数
    const initialGrowthRate = 2; // 初期の成長率

    //----------------------------------------
    // ▼スタンプ描画関数
    //----------------------------------------
    let isAnimationRunning = false;

    // clickStampが更新されたら描画するための関数
    function drawImageOnCanvas(stampURL) {

      const image = document.createElement('img');
      image.onload = function () {
        //----------------------------------------
        // ▼スタンプを配列に入れる
        //----------------------------------------

        let posX, posY, velocityX;

        if (Math.random() < 0.5) {
          posX = 0;
          // velocityX = 10;

          const velocities = [1, 2, 4, 6, 0];
          const randomIndex = Math.floor(Math.random() * velocities.length);
          velocityX = velocities[randomIndex];

          posY = Math.random() * canvas.height / 4 * 3;
        }
        else {
          posX = canvas.width;
          // ランダムな速度を設定

          const velocities = [-3, -5, -7, -9, -11];
          const randomIndex = Math.floor(Math.random() * velocities.length);
          velocityX = velocities[randomIndex];
          // velocityX = -45;

          posY = Math.random() * canvas.height / 4 * 3;
        }

        // console.log(velocityX)
        const stampInfo = {
          image: image,
          posX: posX,
          posY: posY,
          velocityX: velocityX,
          velocityY: 0,
          size: 0,
          alpha: 1.0,
          isAnimating: true,
        };
        stamps.push(stampInfo);
        // console.log(stamps)

        // アニメーションを開始
        if (!isAnimationRunning) {
          isAnimationRunning = true;
          animate();
        }
      };
      image.src = stampURL; // clickStampsに画像のURLを格納
    };
    //----------------------------------------
    // ▼アニメーションの関数
    //----------------------------------------

    // アニメーションを開始
    // animate();

    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height); // Canvasをクリア

      // 速度を更新
      for (let i = 0; i < stamps.length; i++) {
        const stamp = stamps[i];

        if (stamp.isAnimating) {
          stamp.velocityX *= friction; // 摩擦を適用
          stamp.velocityY *= friction; // 摩擦を適用
          // console.log("読み込み")
          // 位置を更新
          stamp.posX += stamp.velocityX; // 速度による位置の変化
          stamp.posY += stamp.velocityY; // 速度による位置の変化

          // サイズを更新
          const distanceToTarget = Math.sqrt((targetX - stamp.posX) ** 2 + (targetY - stamp.posY) ** 2);
          const growthRate = initialGrowthRate * (1 + distanceToTarget / canvas.width); // 距離に応じて成長率を調整

          // サイズを更新
          if (stamp.size < 150) {
            stamp.size += growthRate; // 成長率によるサイズの増加
          } else if (stamp.size >= 150 && stamp.size < maxSize) {
            stamp.size += growthRate; // 400から500の間も成長を続ける
            stamp.alpha -= 0.05; // 透明度を下げる
          }
          ctx.globalAlpha = stamp.alpha;

          // スタンプの中央座標を計算
          const centerX = stamp.posX + stamp.size / 2;
          const centerY = stamp.posY + stamp.size / 2;

          // スタンプの中央座標を中心に描画
          ctx.drawImage(stamp.image, centerX - stamp.size / 2, centerY - stamp.size / 2, stamp.size, stamp.size);

          if (stamp.alpha <= 0 || stamp.size > 200) {
            stamp.alpha = 0; // 透明度が-10のままキープする
            // stamps.shift(); // 配列の先頭から削除
            // console.log(stamp.size, stamp.alpha)
            // console.log("配列の先頭から削除しました", stamps);

            stamp.isAnimating = false;
          };
        };
      }
      if (stamps.length > 0) {
        requestAnimationFrame(animate);
      }
    };

    //----------------------------------------
    // ▼ダブルクリックされないようにする関数
    //----------------------------------------

    document.addEventListener('dblclick', function (e) {
      e.preventDefault();
    });


  </script>
</body>

</html>