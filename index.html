<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport"
    content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">


  <title>GGA2023Autumn</title>

  <!-- CSS & Tailwind -->
  <!-- <link rel="stylesheet" href="css/reset.css" /> -->
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://cdn.tailwindcss.com"></script>

</head>

<body>
  <!----------------------------------------------
    â­ï¸ã‚¿ã‚¤ãƒˆãƒ«
    ------------------------------------------------->
  <section>
    <div class="flex flex-col items-center justify-center" style="background-color: #02a7e9;">
      <div class="canvas-wrapper relative">
        <img src="img/tv2.png" class="rounded-lg">
        <canvas id="overlay"></canvas>
      </div>
    </div>
  </section>
  <!----------------------------------------------
    â­ï¸ã‚¹ã‚¿ãƒ³ãƒ—è¡¨ç¤ºã‚¨ãƒªã‚¢  
    ------------------------------------------------->
  <div class="flex flex-col items-center justify-center px-2 py-2 mx-auto bg-gray-200">
    <div class="w-full bg-white rounded-lg shadow sm:max-w-3xl md:w-4/5 xl:p-0">
      <div class="px-3 py-2 space-y-4 md:space-y-4 sm:p-8">
        <div>
          <div class="text-left mb-1">
            <p class="text-lg">
              â­ï¸ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ãƒ†ãƒ¬ãƒ“ã«é£›ã°ã›ã¾ã™
            </p>
            <p class="text-lg">
              â­ï¸éŸ³å£°ãŒå‡ºã¾ã™â™ª
            </p>

          </div>
        </div>
      </div>
    </div>
  </div>


  </div>

  <div id="stampListContainer" class="flex flex-wrap justify-between p-1">
  </div>

  <!----------------------------------------------
    â­ï¸ãƒãƒ¼ãƒˆãƒãƒ¼ã‚¯
    ------------------------------------------------->
  <div class="circle">
    <img src="img/heart2.png" class="heart" id="heartImage" />
  </div>

  <script type="module">
    //------------------------------------------
    // â–¼firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨javaScriptã‚’é€£æºã•ã›ã‚‹
    //------------------------------------------


    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";

    // firebase firestoreã¨ã‚„ã‚Šå–ã‚Šã‚’ã™ã‚‹è¨­å®š
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      query,
      orderBy, //ãƒ‡ãƒ¼ã‚¿ã®ã‚½ãƒ¼ãƒˆ
      onSnapshot, // Firestore ä¸Šã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      doc,
      deleteDoc,
      updateDoc,
      getDocs,
      getDoc,
      increment,
    } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";

    // firebase storageã¨ã‚„ã‚Šå–ã‚Šã‚’ã™ã‚‹è¨­å®š
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL,
    } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-storage.js";

    // ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®Firebaseã®è¨­å®š
    const firebaseConfig = {
      apiKey: "",
      authDomain: "tvcha-9cae7.firebaseapp.com",
      projectId: "tvcha-9cae7",
      storageBucket: "tvcha-9cae7.appspot.com",
      messagingSenderId: "866848033597",
      appId: "1:866848033597:web:c6887382eb14ee58351354",
    };

    // Firebaseã®åˆæœŸåŒ–
    const app = initializeApp(firebaseConfig);

    // Firebaseã‚¢ãƒ—ãƒªã¨Cloud Storageã®é€£æºã‚’åˆæœŸåŒ–ã—ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹
    const storage = getStorage(app);

    // dbã«å¯¾ã—ã¦ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ ã‚„å–å¾—ãŒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
    const db = getFirestore(app);

    // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®åå‰ã‚’å®šç¾©
    const collectionName = "gga";
    // const collectionUsernName = "alter-user";

    // ğŸ”½ ãƒ‡ãƒ¼ã‚¿å–å¾—æ¡ä»¶ã®æŒ‡å®šï¼ˆä»Šå›ã¯orderé †ã«ä¸¦ã³æ›¿ãˆã¦å–å¾—ï¼‰
    const q = query(collection(db, collectionName), orderBy("order", "desc"));

    //----------------------------------------
    // â–¼ãƒãƒ¼ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã®é–¢æ•°
    //----------------------------------------
    const heartClick = () => {
      const heartImage = document.getElementById('heartImage');

      heartImage.addEventListener('click', async () => {

        heartImage.style.transition = 'none'; // ä¸€æ™‚çš„ã«transitionã‚’ç„¡åŠ¹ã«ã™ã‚‹
        heartImage.style.opacity = "0.5";  // Opacity ã‚’ 0.5 ã«è¨­å®š

        // å°‘ã—é…å»¶ã•ã›ã¦ opacity ã‚’ 1 ã«æˆ»ã™
        setTimeout(() => {
          heartImage.style.transition = '';
          heartImage.style.opacity = "1";
        }, 10);

        await updateDoc(doc(db, "startup_kyushu2023", 'qR17Y24YzQdUyrrMwKzs'), {
          count: increment(1)
        });
      });
    };

    heartClick();

    //----------------------------------------
    // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¹ã‚¿ãƒ³ãƒ—ã®URLã‚’æ ¼ç´ã™ã‚‹é…åˆ—
    //----------------------------------------
    let clickStamp = "";
    const clickStamps = [];
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    const stamps = []; // ã‚¹ã‚¿ãƒ³ãƒ—ã®æƒ…å ±ã‚’ä¿æŒã™ã‚‹é…åˆ—

    //----------------------------------------
    // â–¼æœ€åˆã®ã‚¹ã‚¿ãƒ³ãƒ—ç”»åƒãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    //----------------------------------------

    const initialSnapshot = await getDocs(q);
    const initialArray = [];
    initialSnapshot.docs.forEach(function (doc) {
      const document = {
        id: doc.id,
        data: doc.data(),
      };
      initialArray.push(document);
    });
    const initialImageUrls = []; // imageUrlsã‚’åˆæœŸåŒ–ã—ã¦ãŠã
    const initialCounts = [];

    initialArray.forEach(function (document, index) {

      // imageUrlsã«document.data.imgã‚’è¿½åŠ 
      initialImageUrls.push(document.data.img);
      initialCounts.push(document.data.count || 0);
      console.log(initialCounts);
    });
    let totalCount = initialCounts.reduce((sum, count) => sum + count, 0);


    //----------------------------------------
    // â–¼ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    //----------------------------------------

    const imageElements = [];

    const renderImages = () => {
      stampListContainer.innerHTML = '';

      initialImageUrls.forEach((imageUrl, index) => {
        const imageWrapper = document.createElement('div');
        imageWrapper.className = 'image-wrapper';

        const imageElement = document.createElement('img');
        imageElement.src = imageUrl;
        imageElement.className = 'image';
        imageElement.style.marginBottom = '8px';
        imageElements.push(imageElement)

        imageWrapper.appendChild(imageElement);

        stampListContainer.appendChild(imageWrapper);
      });
    }
    renderImages();

    // console.log("imageElements", imageElements);

    //----------------------------------------
    // â–¼ã‚¹ã‚¿ãƒ³ãƒ—ã‚¯ãƒªãƒƒã‚¯é–¢æ•°ã€ãƒã‚¤ãƒ³ãƒˆåŠ ç®—é–¢æ•°
    //----------------------------------------
    const stampClick = async (stampId) => {

      // Firebaseã®ã‚¯ãƒªãƒƒã‚¯æ•°ã‚’ä¸€ã¤å¢—ã‚„ã™
      await updateDoc(doc(db, collectionName, stampId), {
        count: increment(1)
      });
      // console.log("ã‚«ã‚¦ãƒ³ãƒˆãŒæ­£å¸¸ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸã‚ˆã€‚");
    };
    //----------------------------------------
    // â–¼ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¹ã‚¿ãƒ³ãƒ—ã®IDã‚’å–å¾—ã™ã‚‹é–¢æ•°
    //----------------------------------------

    let isClickDisabled = false; // ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹ãƒ•ãƒ©ã‚°

    // ç”»åƒè¦ç´ ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    imageElements.forEach((imageElement, index) => {
      imageElement.addEventListener('click', () => {

        // ã‚¯ãƒªãƒƒã‚¯ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
        // if (isClickDisabled) return;

        const stampId = initialArray[index].id; // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®IDã‚’å–å¾—
        stampClick(stampId);

        // ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®æŒ™å‹•
        imageElement.classList.add('clicked-image'); // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‰ 'clicked-image' ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
        // isClickDisabled = true; // ã‚¯ãƒªãƒƒã‚¯ã‚’ç„¡åŠ¹åŒ–

        setTimeout(() => {
          imageElement.classList.remove('clicked-image'); // ä¸€å®šæ™‚é–“çµŒéå¾Œã« 'clicked-image' ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
          // isClickDisabled = false; // ä¸€å®šæ™‚é–“å¾Œã«ã‚¯ãƒªãƒƒã‚¯ã‚’å†åº¦æœ‰åŠ¹ã«ã™ã‚‹
        }, 1000);
      });
    });

    //----------------------------------------
    // â–¼canvasèƒŒæ™¯ã®ç”»åƒã®å¤§ãã•ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    //----------------------------------------
    let canvasImage = document.querySelector('.canvas-wrapper img');

    // ç”»åƒãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰ã€ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’è¨­å®šã™ã‚‹
    canvasImage.addEventListener('load', function () {
      canvas.width = canvasImage.width;
      canvas.height = canvasImage.height;
    });

    // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒãƒªã‚µã‚¤ã‚ºã•ã‚ŒãŸã¨ãã‚‚ã€ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’å†è¨­å®šã™ã‚‹
    window.addEventListener('resize', function () {
      canvas.width = canvasImage.width;
      canvas.height = canvasImage.height;
    });

    // ç”»åƒãŒã™ã§ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆã®å¯¾å‡¦
    if (canvasImage.complete) {
      canvas.width = canvasImage.width;
      canvas.height = canvasImage.height;
    }

    //----------------------------------------
    // â–¼firebaseãŒæ›´æ–°ã•ã‚Œã‚‹ã”ã¨ã«å‡¦ç†ã‚’å®Ÿè¡Œ
    //----------------------------------------
    // let totalCount = 0;

    // ãƒ‡ãƒ¼ã‚¿å–å¾—å‡¦ç†(ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸Šã§ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ãŒç™ºç”Ÿã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ {} å†…ã®å‡¦ç†ã‚’å®Ÿè¡Œ)
    onSnapshot(q, (querySnapshot) => {
      console.log("Total Count:", totalCount);
      totalCount = 0;

      // å„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®countãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’åˆè¨ˆã™ã‚‹
      querySnapshot.docs.forEach(doc => {
        totalCount += doc.data().count || 0; // ä¸‡ãŒä¸€countãŒundefinedã®å ´åˆã¯0ã¨ã—ã¦æ‰±ã„ã¾ã™
      });

      // console.log("Total Count:", totalCount); // åˆè¨ˆå€¤ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤º

      querySnapshot.docChanges().forEach((change) => {
        if (change.type === "modified") {
          const stampURL = change.doc.data().img;
          drawImageOnCanvas(stampURL);
        }
      });
    });


    //----------------------------------------
    // â–¼ã‚°ãƒ©ãƒ•ã‚’æç”»
    //----------------------------------------    

    const drawBarGraph = (totalCount) => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      console.log("æç”»æˆåŠŸ");
      const maxHeight = canvas.height * 0.2;
      const barHeight = (totalCount / 100 * 2) * maxHeight;

      ctx.globalAlpha = 1.0;  // <- é€æ˜åº¦ã‚’1ã«è¨­å®š
      ctx.fillStyle = "white";  // ãƒãƒ¼ã®è‰²
      ctx.fillRect(0, canvas.height - barHeight, canvas.width, barHeight);
    }



    //----------------------------------------
    // â–¼åŸºæœ¬ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®š
    //----------------------------------------

    const targetX = Math.random() * canvas.width;

    const targetY = (canvas.height) / 2; // ç”»é¢ä¸­å¤®ã®Yåº§æ¨™
    const maxSize = 200; // æœ€å¤§ã‚µã‚¤ã‚º
    let friction = 0.95; // æ‘©æ“¦ä¿‚æ•°
    const initialGrowthRate = 2; // åˆæœŸã®æˆé•·ç‡

    //----------------------------------------
    // â–¼ã‚¹ã‚¿ãƒ³ãƒ—æç”»é–¢æ•°
    //----------------------------------------
    let isAnimationRunning = false;

    // clickStampãŒæ›´æ–°ã•ã‚ŒãŸã‚‰æç”»ã™ã‚‹ãŸã‚ã®é–¢æ•°
    const drawImageOnCanvas = (stampURL) => {
      const image = document.createElement('img');
      //----------------------------------------
      // â–¼ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é…åˆ—ã«å…¥ã‚Œã‚‹
      //----------------------------------------
      let posX, posY, velocityX;

      if (Math.random() < 0.5) {
        posX = 0;
        const velocities = [1, 2, 4, 6, 0];
        const randomIndex = Math.floor(Math.random() * velocities.length);
        velocityX = velocities[randomIndex];
        posY = Math.random() * canvas.height / 4 * 3;
      }
      else {
        posX = canvas.width;
        // ãƒ©ãƒ³ãƒ€ãƒ ãªé€Ÿåº¦ã‚’è¨­å®š
        const velocities = [-3, -5, -7, -9, -11];
        const randomIndex = Math.floor(Math.random() * velocities.length);
        velocityX = velocities[randomIndex];
        posY = Math.random() * canvas.height / 4 * 3;
      }

      const stampInfo = {
        image: image,
        posX: posX,
        posY: posY,
        velocityX: velocityX,
        velocityY: 0,
        size: 0,
        alpha: 1.0,
        isAnimating: true,
      };
      stamps.push(stampInfo);


      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
      if (!isAnimationRunning) {
        isAnimationRunning = true;
        animate();
      }
      image.src = stampURL; // clickStampsã«ç”»åƒã®URLã‚’æ ¼ç´
    };
    //----------------------------------------
    // â–¼ã‚¹ã‚¿ãƒ³ãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®é–¢æ•°
    //----------------------------------------
    const updateAndDrawStamps = () => {
      for (let i = 0; i < stamps.length; i++) {
        const stamp = stamps[i];

        if (stamp.isAnimating) {
          stamp.velocityX *= friction;
          stamp.velocityY *= friction;
          stamp.posX += stamp.velocityX;
          stamp.posY += stamp.velocityY;

          const distanceToTarget = Math.sqrt((targetX - stamp.posX) ** 2 + (targetY - stamp.posY) ** 2);
          const growthRate = initialGrowthRate * (1 + distanceToTarget / canvas.width);

          if (stamp.size < 150) {
            stamp.size += growthRate;
          } else if (stamp.size >= 150 && stamp.size < maxSize) {
            stamp.size += growthRate;
            stamp.alpha -= 0.05;
          }

          ctx.globalAlpha = stamp.alpha;
          const centerX = stamp.posX + stamp.size / 2;
          const centerY = stamp.posY + stamp.size / 2;
          ctx.drawImage(stamp.image, centerX - stamp.size / 2, centerY - stamp.size / 2, stamp.size, stamp.size);

          if (stamp.alpha <= 0 || stamp.size > 200) {
            stamp.alpha = 0;
            stamp.isAnimating = false;
          };
        }
      }
    };

    //----------------------------------------
    // ç”»åƒã‚’èª­ã¿è¾¼ã‚€
    //----------------------------------------
    const bgImage = new Image();
    bgImage.src = 'img/tv2.png';

    // ç”»åƒã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã«æç”»ã™ã‚‹é–¢æ•°
    const drawBackgroundImage = () => {

      // ç”»åƒã‚’æç”»
      ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
    };

    //----------------------------------------
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
    //----------------------------------------
    const animate = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height); // Canvasã‚’ã‚¯ãƒªã‚¢

      drawBarGraph(totalCount);
      drawBackgroundImage();
      updateAndDrawStamps();

      if (stamps.length > 0) {
        requestAnimationFrame(animate);
      }
    };


    drawBarGraph(totalCount);
    drawBackgroundImage();

    //----------------------------------------
    // â–¼ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹é–¢æ•°
    //----------------------------------------

    document.addEventListener('dblclick', function (e) {
      e.preventDefault();
    });


  </script>
</body>

</html>