<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport"
    content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">


  <title>GGA2023Autumn</title>

  <!-- CSS & Tailwind -->
  <!-- <link rel="stylesheet" href="css/reset.css" /> -->
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://cdn.tailwindcss.com"></script>

</head>

<body>
  <!----------------------------------------------
    ⭐️タイトル
    ------------------------------------------------->
  <section>
    <div class="flex flex-col items-center justify-center">
      <div class="canvas-wrapper relative">
        <img src="img/tv2.png">
        <canvas id="overlay"></canvas>
      </div>
    </div>
    <div>
      <button id="resetButton" top="-50" left="100"
        class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full">
        clear
      </button>
    </div>
  </section>

  <!-- 左下のA_Groupのパーセンテージ表示 -->
  <div id="AGroupPercentage" style="font-size: 100px; position: absolute; bottom: 21px; left: 71px;">
  </div>

  <!-- 左下のA_Groupの個数表示 -->
  <div id="AGroupCount" class="stampCount" style="font-size: 20px; position: absolute; bottom: 0; left: 0;z-index: 5">
  </div>

  <!-- 右側のB_Groupのパーセンテージ表示 -->
  <div id="BGroupPercentage" style="font-size: 100px; position: absolute; bottom: 21px; right: -55px;"></div>

  <!-- 右下のA_Groupの個数表示 -->
  <div id="BGroupCount" class="stampCount" style="font-size: 20px; position: absolute; bottom: 0; right: 0;z-index: 5">
  </div>

  <!----------------------------------------------
    ⭐️注意書き
    ------------------------------------------------->
  <div class="flex flex-col items-center justify-center px-2 py-2 mx-auto bg-gray-200">
    <div class="w-full bg-white rounded-lg shadow sm:max-w-3xl md:w-4/5 xl:p-0">
      <div class="px-3 py-2 space-y-4 md:space-y-4 sm:p-8">
        <div>
          <div class="text-left mb-1">
            <p class="text-lg">
              ⭐️スタンプをテレビに飛ばせます
            </p>
            <p class="text-lg">
              ⭐️音声が出ます♪
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!----------------------------------------------
    ⭐️スタンプ表示エリア
    ------------------------------------------------->
  </div>
  <div id="stampListContainer" class="flex flex-wrap justify-between p-1">
  </div>

  <!----------------------------------------------
    ⭐️送ったスタンプ表示エリア
    ------------------------------------------------->
  <div class="flex flex-col items-center justify-center px-3 pt-3 pb-3 mx-auto">
    <div class="w-full bg-white rounded-lg shadow sm:max-w-3xl md:w-4/5 xl:p-0">
      <div class="p-3" id="slot">
        <div class="mb-2 text-lg text-gray-700 font-medium text-center" id="thanks">
          ⛑ 送れるスタンプは１日３回まで 😊
        </div>
        <div>
          <div class="dotted-circles-container">
            <div class="dotted-circle image-slot">1</div>
            <div class="dotted-circle image-slot">2</div>
            <div class="dotted-circle image-slot">3</div>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      //------------------------------------------
      // ▼firebaseプロジェクトとjavaScriptを連携させる
      //------------------------------------------


      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";

      // firebase firestoreとやり取りをする設定
      import {
        getFirestore,
        collection,
        addDoc,
        serverTimestamp,
        query,
        orderBy, //データのソート
        onSnapshot, // Firestore 上に保存されているデータを取得
        doc,
        deleteDoc,
        updateDoc,
        getDocs,
        getDoc,
        increment,
      } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";

      // firebase storageとやり取りをする設定
      import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL,
      } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-storage.js";

      // ウェブアプリのFirebaseの設定
      const firebaseConfig = {
        apiKey: "",
        authDomain: "tvcha-9cae7.firebaseapp.com",
        projectId: "tvcha-9cae7",
        storageBucket: "tvcha-9cae7.appspot.com",
        messagingSenderId: "866848033597",
        appId: "1:866848033597:web:c6887382eb14ee58351354",
      };

      // Firebaseの初期化
      const app = initializeApp(firebaseConfig);

      // FirebaseアプリとCloud Storageの連携を初期化しセットアップする
      const storage = getStorage(app);

      // dbに対してデータの追加や取得ができるようにする
      const db = getFirestore(app);

      // コレクションの名前を定義
      const collectionName = "gga";
      // const collectionUsernName = "alter-user";

      // 🔽 データ取得条件の指定（今回はorder順に並び替えて取得）
      const q = query(collection(db, collectionName), orderBy("order", "desc"));

      //----------------------------------------
      // クリックされたスタンプのURLを格納する配列
      //----------------------------------------
      let clickStamp = "";
      const clickStamps = [];
      const canvas = document.getElementById('overlay');
      const ctx = canvas.getContext('2d');
      const stamps = []; // スタンプの情報を保持する配列

      //----------------------------------------
      // ▼スタンプのクリック数カウント
      //----------------------------------------
      let AGroupCount = 0;
      let BGroupCount = 0;
      let totalCount = 0;
      let AGroupPercentage = 0;
      let BGroupPercentage = 0;

      // AグループとBグループのIDのリスト
      const AGroupIds = ['Sw077n0mreVj9exRh81f', 'xrnvFgD3PCjestA64SGd', 'ZXxNNOE8iKsrg8x3UiZ8', 'hgGsPbYmVKtw1ZLxljcr'];
      const BGroupIds = ['p1DmVCDLRcPBgpdGfTuY', 'NgLy7OAjlR6b7LF3Bfmp', 'xrnvFgD3PCjestA64SGd', 'gfYdaXfqBcumPyn5puV9'];

      //----------------------------------------
      // カウントとパーセンテージを計算する関数

      //----------------------------------------
      const calculateCountsAndPercentages = (docs) => {
        // カウントをリセット
        AGroupCount = 0;
        BGroupCount = 0;
        totalCount = 0;

        // 各ドキュメントのカウントを集計する
        docs.forEach((doc) => {
          const docId = doc.id;
          const docCount = doc.data().count || 0;

          if (AGroupIds.includes(docId)) {
            AGroupCount += docCount;
          }
          if (BGroupIds.includes(docId)) {
            BGroupCount += docCount;
          }
        });

        // 合計カウントとパーセンテージを計算
        totalCount = AGroupCount + BGroupCount;
        AGroupPercentage = (totalCount > 0) ? (AGroupCount / totalCount) * 100 : 0;
        BGroupPercentage = (totalCount > 0) ? (BGroupCount / totalCount) * 100 : 0;

        // 結果をコンソールに出力
        console.log('AGroupCount:', AGroupCount, 'BGroupCount:', BGroupCount);
        console.log('AGroupPercentage:', AGroupPercentage.toFixed(2), 'BGroupPercentage:', BGroupPercentage.toFixed(2));
      };


      //----------------------------------------
      // ▼最初のスタンプ画像データの読み込み
      //----------------------------------------

      const initialSnapshot = await getDocs(q);
      // calculateCountsAndPercentages(initialSnapshot.docs);

      const initialArray = initialSnapshot.docs.map(doc => ({
        id: doc.id,
        data: doc.data(),
      }));

      const initialImageUrls = initialArray.map(doc => doc.data.img);



      // データ取得処理(データベース上でデータの変更が発生したタイミングで {} 内の処理を実行)
      onSnapshot(q, (querySnapshot) => {
        calculateCountsAndPercentages(querySnapshot.docs);
        drawBarGraph(AGroupPercentage, BGroupPercentage);

        querySnapshot.docChanges().forEach((change) => {
          if (change.type === "modified") {
            const stampURL = change.doc.data().img;
            drawImageOnCanvas(stampURL);
            // console.log(stampURL);
          }
        });
      });

      //----------------------------------------
      // ▼スタンプを表示する関数
      //----------------------------------------

      const imageElements = [];

      const renderImages = () => {
        stampListContainer.innerHTML = '';

        initialImageUrls.forEach((imageUrl, index) => {
          const imageWrapper = document.createElement('div');
          imageWrapper.className = 'image-wrapper';

          const imageElement = document.createElement('img');
          imageElement.src = imageUrl;
          imageElement.className = 'image';
          imageElement.style.marginBottom = '8px';
          imageElements.push(imageElement)

          imageWrapper.appendChild(imageElement);

          stampListContainer.appendChild(imageWrapper);
        });
      }
      renderImages();

      // console.log("imageElements", imageElements);

      //----------------------------------------
      // ▼スタンプクリック関数
      //----------------------------------------
      const stampClick = async (stampId) => {

        // Firebaseのクリック数を一つ増やす
        await updateDoc(doc(db, collectionName, stampId), {
          count: increment(1)
        });
        // console.log("カウントが正常に更新されましたよ。");
      };
      //----------------------------------------
      // ▼クリックされたスタンプのIDを取得する関数
      //----------------------------------------

      let isClickDisabled = false; // クリック無効フラグ

      // 画像要素にクリックイベントリスナーを追加
      imageElements.forEach((imageElement, index) => {
        imageElement.addEventListener('click', () => {

          // console.log(imageElement.src);

          // クリックが無効化されている場合は処理をスキップ
          // if (isClickDisabled) return;

          const stampId = initialArray[index].id; // クリックされたドキュメントのIDを取得
          setTimeout(() => {
            stampClick(stampId);
          }, 1000);

          // ボタンが押された時の挙動
          imageElement.classList.add('clicked-image'); // クリックされたら 'clicked-image' クラスを追加
          // isClickDisabled = true; // クリックを無効化

          setTimeout(() => {
            imageElement.classList.remove('clicked-image'); // 一定時間経過後に 'clicked-image' クラスを削除
            // isClickDisabled = false; // 一定時間後にクリックを再度有効にする
          }, 1000);

          //----------------------------------------
          // ▼クリックした画像の表示
          //----------------------------------------
          setTimeout(function () {
            displayImageInSlot(imageElement.src);
          }, 1000);
        });
      });



      //----------------------------------------
      // ▼canvas背景の画像の大きさを取得する関数
      //----------------------------------------

      let canvasImage = document.querySelector('.canvas-wrapper img');

      // function setCanvasSizeAndDraw() {
      //   canvas.width = canvasImage.width;
      //   canvas.height = canvasImage.height;
      // }

      // ウィンドウがリサイズされたときも、キャンバスのサイズを再設定する
      window.addEventListener('resize', function () {
        canvas.width = canvasImage.width;
        canvas.height = canvasImage.height;
      });

      // 画像がすでに読み込まれている場合の対処
      if (canvasImage.complete) {
        canvas.width = canvasImage.width;
        canvas.height = canvasImage.height;
      }
      //----------------------------------------
      // テレビの中の座標
      //----------------------------------------

      // 矩形の左上隅の座標
      const rectX = canvas.width / 10.2;
      const rectY = canvas.height / 17;

      // 矩形の幅と高さ
      const rectWidth = canvas.width / 1.265;
      const rectHeight = canvas.height / 1.62;

      // 矩形の描画
      // ctx.fillStyle = 'purple';
      // ctx.fillRect(rectX, rectY, rectWidth, rectHeight);

      // 左下の座標
      const bottomLeftX = rectX;
      const bottomLeftY = rectY + rectHeight;

      // 右下の座標
      const bottomRightX = rectX + rectWidth;
      const bottomRightY = rectY + rectHeight;

      // 変数に格納
      let bottomLeft = { x: bottomLeftX, y: bottomLeftY };
      let bottomRight = { x: bottomRightX, y: bottomRightY };


      //----------------------------------------
      // ▼パーセンテージのイーズインアニメーション
      //----------------------------------------

      let previousAGroupPercentage = 0; // 前回のパーセンテージを保持する変数
      let previousBGroupPercentage = 0; // 前回のBGroupPercentageを保持する変数を追加

      function easeInAnimation(startValue, endValue, duration, updateFunction) {
        let startTime = null;

        function animate(time) {
          if (!startTime) startTime = time;

          let elapsedTime = time - startTime;
          let progress = elapsedTime / duration;

          if (progress > 1) progress = 1;

          // イーズインの計算
          let currentValue = startValue + (endValue - startValue) * (progress * progress);

          updateFunction(currentValue);

          if (progress < 1) requestAnimationFrame(animate);
        }

        requestAnimationFrame(animate);
      }

      //----------------------------------------
      // ▼パーセンテージの表示関数
      //----------------------------------------

      function calculatePercentage() {
        // console.log("AGroupCount", AGroupCount, "BGroupCount", BGroupCount)
        let isFirstCall = true;

        // パーセンテージの計算
        const total = AGroupCount + BGroupCount;
        // console.log(total)
        AGroupPercentage = Math.round((AGroupCount / total) * 100); // 小数点を丸める
        BGroupPercentage = 100 - AGroupPercentage;

        // AGroupPercentageの新しい値のアニメーション
        let newAGroupPercentage = Math.round((AGroupCount / total) * 100);

        easeInAnimation(previousAGroupPercentage, newAGroupPercentage, 1000, function (value) {
          document.getElementById("AGroupPercentage").innerHTML = `${Math.round(value)}<span id="Apercentage">%</span>`;
        });

        previousAGroupPercentage = newAGroupPercentage; // 前回のAGroupPercentageを更新

        // BGroupPercentageの新しい値のアニメーション
        let newBGroupPercentage = 100 - newAGroupPercentage;

        easeInAnimation(previousBGroupPercentage, newBGroupPercentage, 1000, function (value) {
          document.getElementById("BGroupPercentage").innerHTML = `${Math.round(value)}<span id="Bpercentage">%</span>`;
        });

        previousBGroupPercentage = newBGroupPercentage; // 前回のBGroupPercentageを更新

        // HTML要素にパーセンテージを表示

        // document.getElementById("AGroupPercentage").innerHTML = `${AGroupPercentage}<span id="Apercentage">%</span>`;
        // document.getElementById("AGroupCount").innerHTML = `${AGroupCount}`;
        // document.getElementById("BGroupPercentage").innerHTML = `${BGroupPercentage}<span id="Bpercentage">%</span>`;
        // document.getElementById("BGroupCount").innerHTML = `${BGroupCount}`;
        // console.log("AGroupPercentage", AGroupPercentage);
        // console.log("BGroupPercentage", BGroupPercentage);

      }
      // drawImageOnCanvas(clickStamp);
      // drawBarGraph(AGroupPercentage, BGroupPercentage);
      // console.log(clickStamp, BGroupPercentage)

      //----------------------------------------
      // ▼スタンプ描画関数
      //----------------------------------------
      let isAnimationRunning = false;

      const GRAVITY = 0.03; // 重力の強さ
      const FRICTION = 0.3; // 摩擦係数
      // const CONSTANT_VELOCITY = 5;

      // clickStampが更新されたら描画するための関数
      // function drawImageOnCanvas(stampURL, stampType) {
      function drawImageOnCanvas(stampURL) {
        const image = document.createElement('img');
        image.className = "stampMoving";
        image.onload = () => {
          //----------------------------------------
          // ▼aかbかを振り分ける
          //----------------------------------------
          // let startX;s
          // if (['a1', 'a2', 'a3', 'a4', 'a5', 'a6', 'a7', 'a8'].includes(stampType)) {
          // startX = Math.random() * 180 + 10;

          // } else if (['b1', 'b2', 'b3', 'b4', 'b5', 'b6', 'b7', 'b8'].includes(stampType)) {
          // ここでスタンプの最大サイズを引いて右側のスタンプが見切れないように調整します
          // const maxStampSize = 30; // スタンプの最大サイズを適切な値に設定する
          // startX = canvas.width - maxStampSize - 230 + Math.random() * 180;
          // }
          //----------------------------------------
          // ▼基本パラメータを設定して、オブジェクトを作成
          //----------------------------------------

          const stampInfo = {
            image: image,
            posX: Math.random() * canvas.width,
            posY: -100,
            velocityX: 0,
            initialVelocityY: 0.7 + Math.random() * 3,
            velocityY: 0.3 + Math.random(),
            size: 100,
            sizeRate: 0.5 + Math.random() * 0.5,
            isAnimating: true,
            opacity: 1.0,
          };
          // console.log("stampInfo", stampInfo);
          stamps.push(stampInfo);
          // console.log(stamps.length)

          // アニメーションを開始
          if (!isAnimationRunning) {
            isAnimationRunning = true;
            animate();
            // console.log(stamps.length)
          }
        };
        image.src = stampURL; // clickStampsに画像のURLを格納
      };

      //----------------------------------------
      // スタンプの距離を測る関数
      //----------------------------------------

      function areStampsColliding(stamp1, stamp2) {
        const dx = stamp1.posX - stamp2.posX;
        const dy = stamp1.posY - stamp2.posY;
        const distance = Math.sqrt(dx * dx + dy * dy);
        return distance < (stamp1.size + stamp2.size) / 2;
      };

      //----------------------------------------
      // キャンバスの中央から左右100pxの範囲の境界を定義
      //----------------------------------------
      const leftBoundary = canvas.width / 2 - canvas.width / 4;
      const rightBoundary = canvas.width / 2 + canvas.width / 5;;
      // console.log(leftBoundary, rightBoundary)


      //----------------------------------------
      // セーフティエリアの線を引く関数
      //----------------------------------------
      function drawSafetyArea() {
        const safetyAreaPercentage = 0.93;
        const safetyAreaWidth = canvas.width * safetyAreaPercentage;
        const safetyAreaHeight = canvas.height * safetyAreaPercentage;

        // 枠線の開始位置を計算（中央に配置するためのオフセットを計算）
        const offsetX = (canvas.width - safetyAreaWidth) / 2;
        const offsetY = (canvas.height - safetyAreaHeight) / 2;

        ctx.strokeStyle = 'white'; // 枠線の色
        ctx.lineWidth = 2;         // 枠線の太さ
        ctx.strokeRect(offsetX, offsetY, safetyAreaWidth, safetyAreaHeight);
      }
      //----------------------------------------
      // ▼アニメーション全体の関数
      //----------------------------------------
      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height); // Canvasをクリア
        drawBarGraph(AGroupPercentage, BGroupPercentage); // ここでグラフを再描画
        // console.log(AGroupPercentage, BGroupPercentage)
        // drawSafetyArea();

        // ctx.fillStyle = 'lightgreen';
        // 指定された範囲に長方形を描画します。
        // ctx.fillRect(leftBoundary, 0, rightBoundary - leftBoundary, canvas.height);

        for (let i = 0; i < stamps.length; i++) {
          // 画面の半分に来たら重ならないようにする
          if (stamps[i].posY > canvas.height / 3 * 2) {

            //----------------------------------------
            // ▼スタンプの衝突関数
            //----------------------------------------
            for (let j = i + 1; j < stamps.length; j++) {
              if (areStampsColliding(stamps[i], stamps[j])) {

                // スタンプが重ならないように位置を調整
                const dx = stamps[j].posX - stamps[i].posX;
                const dy = stamps[j].posY - stamps[i].posY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                const overlap = (stamps[i].size / 2 + stamps[j].size / 2) - distance;

                // 重なっている距離に基づいて位置を調整
                const adjustX = (dx / distance) * overlap;
                const adjustY = (dy / distance) * overlap;

                // 位置を調整
                const margin = 10;
                stamps[i].posX -= adjustX / margin;
                stamps[i].posY -= adjustY / margin;
                stamps[j].posX += adjustX / margin;
                stamps[j].posY += adjustY / margin;
              }
            }
          }

          //----------------------------------------
          // ▼スタンプが中央に寄らないようにする関数
          //----------------------------------------
          if (stamps[i].posX > leftBoundary && stamps[i].posX < rightBoundary) {
            //     スタンプの水平速度を反転
            stamps[i].velocityX = -stamps[i].velocityX;

            if (Math.abs(stamps[i].posX - leftBoundary) < Math.abs(stamps[i].posX - rightBoundary)) {
              stamps[i].posX = leftBoundary;  // leftBoundaryにはりつく
            } else {
              stamps[i].posX = rightBoundary; // rightBoundaryにはりつく
            }
          }

          //----------------------------------------
          // ▼アニメーションの関数
          //----------------------------------------
          const stamp = stamps[i];
          // console.log(stamps.length)
          // const newStampSize = stamp.size * 0.5; // スタンプのサイズ
          // const newStampSize = stamp.size * (Math.random() * 0.5 + 0.5); // スタンプのサイズ
          const newStampSize = stamp.size * stamp.sizeRate;

          if (stamp.isAnimating) {
            stamp.posX += stamp.velocityX;

            // 画面のある位置までの場合
            if (stamp.posY <= canvas.height / 3 * 2) {
              // 速度を一定に保つ（適切な一定の速度を設定する）
              stamp.velocityY = stamp.initialVelocityY;
            } else {
              // 画面のある位置を超えた場合、重力の影響を受けて加速する
              stamp.velocityY += (1 + GRAVITY);
            }
            stamp.posY += stamp.velocityY;
            // stamp.posY += stamp.velocityY;
            // console.log([i], "個目がアニメーション中", stamps[i].velocityY)

            if (stamp.posY + newStampSize > canvas.height) {
              stamp.posY = canvas.height - newStampSize;  // スタンプの位置をcanvasの下端に固定

              // 跳ね返る時に摩擦の影響を受ける
              stamp.velocityY = -stamp.velocityY * FRICTION;

              // 速度が非常に小さい場合、ボールを止める

              if (Math.abs(stamp.velocityY) < 0.5) {
                stamp.velocityY = 0;
                stamp.opacity -= 0.1;
                // setTimeout(() => {
                //     stamp.isAnimating = false;
                // }, 1000);

                // 透明度が0になったら、アニメーションを停止
                if (stamp.opacity <= 0) {
                  stamp.opacity = 0;
                  stamp.isAnimating = false;
                }

              }
            }
            ctx.globalAlpha = stamp.opacity; // 透明度の設定

            // スタンプを描画
            const visibleHeight = stamp.size - (stamp.posY < 0 ? -stamp.posY : 0);  // 画面外にはみ出している部分の高さ
            ctx.drawImage(
              stamp.image,
              0,
              stamp.size - visibleHeight,
              stamp.size, // ソース画像の幅
              visibleHeight, // ソース画像の高さ
              stamp.posX,
              stamp.posY < 0 ? 0 : stamp.posY,
              newStampSize, // 宛先キャンバス上の幅
              newStampSize * (visibleHeight / stamp.size) // 宛先キャンバス上の高さ
            );
            ctx.globalAlpha = 1.0;
          };
        };
        // console.log("テストdrawBarGraph")
        if (stamps.length > 0) {
          requestAnimationFrame(animate);
        }
      };

      //----------------------------------------
      // ▼棒グラフの描画関数
      //----------------------------------------

      let currentAGroupHeight = 0;
      let currentBGroupHeight = 0;
      const lerpRate = 0.05;  // 補完率。0.05のような小さい値でスムーズな変化を得る
      let isFirstDraw = true;

      let imageA = document.createElement('img');
      imageA.src = './img/star_blue.jpg';

      let imageB = document.createElement('img');
      imageB.src = './img/star_red.jpg';
      // console.log(imageA);

      const drawBarGraph = (AGroupPercentage, BGroupPercentage) => {


        // console.log('左下の座標:', bottomLeft);
        // console.log('右下の座標:', bottomRight);

        //----------------------------------------
        // 棒グラフの描画
        //----------------------------------------
        const barWidth = canvas.height / 6;

        const barX1 = canvas.width / 10.2;
        const barX2 = canvas.width - barWidth - barWidth;

        const maxCanvasPercentage = 0.5;  // これはcanvas.heightの50%を意味します。
        const targetAGroupHeight = calculateBarHeight(AGroupPercentage, maxCanvasPercentage, canvas.height);
        const targetBGroupHeight = calculateBarHeight(BGroupPercentage, maxCanvasPercentage, canvas.height);
        // console.log(currentAGroupHeight);

        // 現在の高さを目標の高さに近づける
        if (isFirstDraw) {
          currentAGroupHeight = targetAGroupHeight;
          currentBGroupHeight = targetBGroupHeight;
          isFirstDraw = false;
        } else {
          currentAGroupHeight += (targetAGroupHeight - currentAGroupHeight) * lerpRate;
          currentBGroupHeight += (targetBGroupHeight - currentBGroupHeight) * lerpRate;
        }

        // Aグループのバーグラフのテクスチャを設定
        let patternA = ctx.createPattern(imageA, 'repeat');
        ctx.fillStyle = patternA;
        // ctx.fillStyle = "#0000cc";
        ctx.fillRect(bottomLeftX, bottomLeftY, barWidth, -currentAGroupHeight);
        // console.log(barX1, canvas.height, barWidth, -currentAGroupHeight);

        let patternB = ctx.createPattern(imageB, 'repeat');
        ctx.fillStyle = patternB;
        // ctx.fillStyle = '#cc0000';
        ctx.fillRect(bottomRightX - barWidth, bottomRightY, barWidth, -currentBGroupHeight);

        // // 赤い四角を描く
        // ctx.fillStyle = 'red';
        // ctx.fillRect(canvas.width / 10.2, canvas.height / 15, canvas.width / 1.265, canvas.height / 1.62);
      };

      function calculateBarHeight(percentage, maxCanvasPercentage, canvasHeight) {
        return (percentage / 100) * maxCanvasPercentage * canvasHeight;
      }


      // //----------------------------------------
      // // ▼基本パラメータを設定
      // //----------------------------------------

      // const targetX = Math.random() * canvas.width;

      // const targetY = (canvas.height) / 2; // 画面中央のY座標
      // const maxSize = 200; // 最大サイズ
      // let friction = 0.95; // 摩擦係数
      // const initialGrowthRate = 2; // 初期の成長率



      //----------------------------------------
      // ▼カウントをゼロにする関数
      //----------------------------------------

      const resetCount = async () => {

        const querySnapshot = await getDocs(q)

        querySnapshot.forEach(async (doc) => {

          // ドキュメントのデータを取得
          const docData = doc.data();

          // カウントを0に設定
          docData.count = 0;

          // ドキュメントを更新
          await updateDoc(doc.ref, docData);

        });
      };



      // ボタンクリック時の処理
      const resetButton = document.getElementById("resetButton");
      resetButton.addEventListener("click", resetCount);

      //----------------------------------------
      // ▼点線の丸の幅を設定
      //----------------------------------------
      let circleSize = 110; // デフォルトのサイズ
      let circleMargin = 10; // デフォルトのマージン

      const adjustDottedCircleSize = () => {

        const deviceWidth = window.innerWidth;
        const itemWidth = (deviceWidth - 48) / 3;

        let newSize = circleSize;
        let newMargin = circleMargin;

        if (itemWidth < (circleSize + 2 * circleMargin)) {
          newSize = itemWidth * 0.9;
          newMargin = itemWidth * 0.05;
        }

        // console.log("itemWidth", itemWidth, "circleSize", newSize)

        document.querySelectorAll('.dotted-circle').forEach(circle => {
          circle.style.width = `${newSize}px`;
          circle.style.height = `${newSize}px`;
          circle.style.marginLeft = `${newMargin}px`;
          circle.style.marginRight = `${newMargin}px`;

        });
      };

      // ブラウザのリサイズイベントに応じて調整
      window.addEventListener('resize', adjustDottedCircleSize);

      //----------------------------------------
      // ▼クリックした画像の表示関数
      //----------------------------------------

      const displayImageInSlot = (src, circleSize) => {
        // 画像のsrcを組み立てる
        // const src = `./img/${id}.png`;

        // 最初の空の.image-slotを選択
        const slot = document.querySelector('.image-slot');

        if (slot) {
          // img要素を作成して、src属性を設定
          const img = document.createElement('img');
          img.src = src;
          img.style.width = `${circleSize}px`;    // 画像のサイズを指定
          img.style.height = `${circleSize}px`;   // 画像のサイズを指定
          img.classList.add('fade-in'); // フェードインアニメーションのクラスを追加
          // console.log(img.style.width);

          // 現在の内容 (数字) をクリアして画像を追加
          slot.innerHTML = "";
          slot.appendChild(img);

          // .image-slotクラスを取り除く
          slot.classList.remove("image-slot", "coin-design");
          slot.classList.add("dotted-circle");
        }
      };
      adjustDottedCircleSize();

      //----------------------------------------
      // ▼ダブルクリックされないようにする関数
      //----------------------------------------

      document.addEventListener('dblclick', function (e) {
        e.preventDefault();
      });

    </script>
</body>

</html>